<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</title>
  <meta name="description" content="Ph√°p B·∫£o Ph√∫c L·∫°c Chatbot ‚Äî H·ªèi ƒëi·ªÅu b·∫°n mu·ªën h·ªçc h√¥m nay." />
  <style>
    :root{
      /* b·∫£ng m√†u d·ªãu nh∆∞ ·∫£nh demo */
      --bg:#f4f3f1;         /* n·ªÅn ngo√†i */
      --surface:#ffffff;    /* n·ªÅn th·∫ª */
      --ink:#3b3b3b;        /* m√†u ch·ªØ ch√≠nh */
      --muted:#777;         /* ch·ªØ ph·ª• */
      --brand:#a4383e;      /* nh·∫•n ƒë·ªè sen tr·∫ßm */
      --ring:rgba(164,56,62,.12);
      --chip:#f8eef0;       /* n·ªÅn h·ªìng nh·∫°t */
      --chip-border:#ead2d6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--ink);
    }

    /* khung t·ªïng */
    .wrap{
      max-width:880px;
      margin:32px auto;
      padding:0 12px;
    }

    /* header theo ·∫£nh demo */
    .card{
      background:var(--surface);
      border-radius:20px;
      padding:24px;
      box-shadow:0 8px 30px rgba(0,0,0,.06);
    }
    .header{
      display:flex; gap:16px; align-items:center; justify-content:center; text-align:center;
      padding:24px 12px;
    }
    .logo{
      width:72px;height:72px;border-radius:50%;display:grid;place-items:center;
      background:#fff;border:1px solid #eee; box-shadow:0 2px 10px rgba(0,0,0,.05)
    }
    .logo img{max-width:64px;height:auto;display:block}
    .title h1{margin:0;font-size:28px;font-weight:800;color:#7d2f34;letter-spacing:.3px}
    .title .sub1{margin-top:6px;font-size:12px;color:#b07f3e;letter-spacing:.12em}
    .title .sub2{margin-top:4px;font-size:13px;color:#666;font-style:italic}

    /* khu v·ª±c chat */
    .chat{
      margin-top:18px;
      background:var(--surface);
      border-radius:20px;
      padding:18px;
      box-shadow:0 8px 30px rgba(0,0,0,.06);
      display:flex; flex-direction:column; gap:12px;
      min-height:60vh;
    }

    .greeting{
      color:#7d2f34;
      background:var(--chip);
      border:1px solid var(--chip-border);
      padding:10px 12px; border-radius:12px; font-size:14px; display:flex; gap:6px; align-items:center
    }
    .pin{font-size:18px}

    .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:4px}

    .msg{display:flex;gap:10px;align-items:flex-start}
    .bubble{
      max-width:820px;
      padding:12px 14px; border-radius:14px; line-height:1.55; font-size:15px;
      box-shadow:0 2px 12px rgba(0,0,0,.04)
    }
    .assistant .bubble{background:#eef2f6}
    .user{justify-content:flex-end}
    .user .bubble{background:#f7e9eb;border:1px solid #e9cfd3}

    .composer{position:sticky; bottom:0; background:var(--surface); padding-top:8px}
    .form{display:flex; gap:10px; align-items:flex-end}
    .box{flex:1; position:relative}
    textarea{
      width:100%; min-height:58px; max-height:240px; resize:vertical;
      padding:14px 48px 14px 14px; border-radius:14px; border:1px solid #e4e4e4; outline:none;
      font-size:15px; line-height:1.45; background:#fff;
      box-shadow:0 2px 10px rgba(0,0,0,.04)
    }
    textarea:focus{border-color:var(--brand); box-shadow:0 0 0 4px var(--ring)}
    .send{
      border:none; background:var(--brand); color:#fff; padding:12px 18px; border-radius:14px;
      font-weight:700; cursor:pointer
    }
    .send:disabled{opacity:.6;cursor:not-allowed}
    .hint{margin-top:10px; text-align:center; color:var(--muted); font-size:13px}

    /* n√∫t l√™n ƒë·∫ßu trang */
    .topbtn{
      position:fixed; right:18px; bottom:18px; width:42px; height:42px; border-radius:999px; border:1px solid #e2cdd1;
      display:grid; place-items:center; background:#fff; color:#7d2f34; box-shadow:0 6px 20px rgba(0,0,0,.12);
      cursor:pointer;
    }

    @media (max-width:640px){
      .wrap{margin:16px auto}
      .title h1{font-size:22px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card header">
      <div class="logo"><img src="logo.png" alt="Ph√°p B·∫£o Ph√∫c L·∫°c"></div>
      <div class="title">
        <h1>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</h1>
        <div class="sub1">NAM M√î B·ªîN S∆Ø TH√çCH CA M√ÇU NI PH·∫¨T</div>
        <div class="sub2">‚ÄúHi·ªÉu s√¢u Ch√°nh Ph√°p ‚Äì H∆∞·ªõng ƒë·∫°o tu t·∫≠p‚Äù</div>
      </div>
    </div>

    <div class="chat card" role="region" aria-label="Khu v·ª±c h·ªôi tho·∫°i">
      <div class="greeting"><span class="pin">üìå</span>Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t. B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?</div>

      <div id="messages" class="messages" aria-live="polite" aria-busy="false"></div>

      <div class="composer">
        <form id="composer" class="form" autocomplete="off">
          <div class="box">
            <label class="sr-only" for="input">Nh·∫≠p c√¢u h·ªèi...</label>
            <textarea id="input" placeholder="G√µ c√¢u h·ªèi c·ªßa b·∫°n‚Ä¶ (Shift+Enter xu·ªëng d√≤ng)" rows="3"></textarea>
          </div>
          <button class="send" id="send" type="submit">G·ª≠i</button>
        </form>
        <div class="hint">B·∫°n mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p? B·∫°n c·ª© h·ªèi nh√©, m√¨nh ·ªü ƒë√¢y ƒë·ªìng h√†nh v·ªõi b·∫°n.</div>
      </div>
    </div>
  </div>

  <a class="topbtn" href="#" id="topBtn" title="L√™n ƒë·∫ßu trang">‚ñ≤</a>

  <script>
    const CONFIG = {
      SERVER_URL: '/api/chat',
      SYSTEM_PROMPT: `B·∫°n l√† Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äî tr·ª£ l√Ω Ph·∫≠t h·ªçc t·ª´ bi, khi√™m cung, tr·∫£ l·ªùi r√µ r√†ng, ng·∫Øn g·ªçn, c√≥ tr√≠ch d·∫´n khi ph√π h·ª£p; gi·ªØ ch√°nh ki·∫øn.`
    };
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const formEl = document.getElementById('composer');
    const sendBtn = document.getElementById('send');
    const STORAGE_KEY = 'pbpl_chat_v2';
    let chat = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!chat.length) chat = [{ role:'system', content: CONFIG.SYSTEM_PROMPT }];

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chat)); }
    function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function toHTML(t){
      t = esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br/>');
      return t.replace(/(https?:\/\/[^\s]+)/g,'<a target="_blank" rel="noopener">$1</a>');
    }
    function render(){
      messagesEl.innerHTML='';
      for(const m of chat){ if(m.role==='system') continue;
        const row=document.createElement('div'); row.className='msg '+(m.role==='assistant'?'assistant':'user');
        const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=toHTML(m.content);
        row.appendChild(bubble); messagesEl.appendChild(row);
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    render();

    // scroll-to-top
    document.getElementById('topBtn').addEventListener('click', e=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); });

    // form behaviors
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); formEl.dispatchEvent(new Event('submit')); }});
    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = inputEl.value.trim(); if(!text) return; inputEl.value='';
      chat.push({ role:'user', content:text }); save(); render(); setBusy(true);
      try{
        const res = await fetch(CONFIG.SERVER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ messages: chat }) });
        if(!res.ok) throw new Error('Bad response: '+res.status);
        const data = await res.json();
        const full = data.reply || '';
        // Hi·ªáu ·ª©ng ch·ªØ ch·∫°y
        chat.push({ role:'assistant', content:'' }); save(); render();
        let acc=''; for(let i=0;i<full.length;i++){ acc+=full[i]; chat[chat.length-1].content=acc;
          if(i%3===0){ save(); render(); await new Promise(r=>setTimeout(r,8)); } }
      }catch(err){ chat.push({ role:'assistant', content:'Xin l·ªói, h·ªá th·ªëng ƒëang b·∫≠n ho·∫∑c API ch∆∞a s·∫µn s√†ng.' }); }
      finally{ setBusy(false); save(); render(); }
    });

    function setBusy(b){ sendBtn.disabled=b; }
  </script>
</body>
</html>
