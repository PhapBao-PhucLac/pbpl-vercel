<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äì Chatbot</title>

  <!-- Merriweather cho ti√™u ƒë·ªÅ -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@500;700;900&display=swap" rel="stylesheet">

  <!-- Favicon (tu·ª≥ ƒë∆∞·ªùng d·∫´n c·ªßa ƒë·ªá: ƒë·ªÉ c√πng th∆∞ m·ª•c v·ªõi file n√†y) -->
  <link rel="icon" href="./logo.svg" type="image/svg+xml" />
  <link rel="alternate icon" href="./logo.png" type="image/png" />
  <link rel="apple-touch-icon" href="./logo.png" />

  <style>
    :root{
      --ink:#121212; --muted:#f4f4f5; --line:#e9e9ee;
      --brand:#16a085; --accent:#a855f7; --soft:#fafafa;
    }
    html,body{height:100%;}
    body{
      margin:0; font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #f8f5ff 0, transparent 50%),
        radial-gradient(1000px 400px at 120% 20%, #e8fff6 0, transparent 45%), #fff;
    }
    .wrap{max-width:1024px; margin:28px auto 40px; padding:0 16px;}

    /* Header */
    .hero{text-align:center;margin-bottom:18px;}
    .brand-logo{ width:64px; height:64px; object-fit:contain; display:inline-block; margin-bottom:10px; }
    .hero h1{
      font-family:'Merriweather', Georgia, 'Times New Roman', serif;
      font-weight:900; font-size:36px; letter-spacing:.2px; margin:.2rem 0 0;
    }
    .hero .mantra{ font-size:20px; font-weight:700; opacity:.95; }
    .hero .sub{ font-size:16px; color:#475569; }
    @media (max-width:640px){
      .brand-logo{ width:48px;height:48px; }
      .hero h1{ font-size:26px; }
      .hero .mantra{ font-size:16px; }
      .hero .sub{ font-size:14px; }
    }

    /* Chips ch·ªß ƒë·ªÅ */
    .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:14px 0 20px;}
    .chip{padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;font-size:14px;}
    .chip.active{background:#f0fff7;border-color:#ccefe3;box-shadow:0 0 0 2px #e6faf4 inset;}

    /* Chat card */
    .card{border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.04);}
    #messages{max-height:64vh;min-height:320px;overflow:auto;padding:18px;contain:content;}
    .bubble{padding:12px 14px;margin:10px 0;border-radius:16px;}
    .bubble.user{background:var(--muted);color:var(--ink);margin-left:auto;width:fit-content;max-width:82%;}
    .bubble.assistant{background:#fff;border:1px solid var(--line);max-width:82%;}
    .bubble.note{font-size:12px;opacity:.75;text-align:center;background:transparent;border:none;}

    /* Toolbar trong card */
    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 12px 0;}
    .tb-btn{font:13px/1 system-ui;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;}
    .tb-btn.primary{background:var(--brand);color:#fff;border-color:transparent;}
    .tb-btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Composer */
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:#fff;border-radius:0 0 18px 18px;}
    #chat-input{flex:1;padding:12px 14px;border:2px solid #ddd;border-radius:12px;outline:none;}
    #chat-input:focus{border-color:#c7ece4;box-shadow:0 0 0 3px #eaf8f4;}
    #send-btn{padding:12px 18px;border-radius:12px;border:0;background:var(--brand);color:#fff;cursor:pointer;font-weight:700;}
    #send-btn:disabled{opacity:.6;cursor:not-allowed;}
    .hint{font-size:12px;color:#666;margin:10px 2px;}

    /* Markdown ƒë·∫πp */
    .assistant h1,.assistant h2,.assistant h3{margin:6px 0 8px;}
    .assistant p,.assistant ul,.assistant ol{margin:8px 0;}
    .assistant ul,.assistant ol{padding-left:22px;}
    .assistant code{background:#f6f6f6;padding:2px 6px;border-radius:6px;}
    .assistant a{color:#0ea5e9;text-decoration:none;} .assistant a:hover{text-decoration:underline;}

    /* G·ª£i √Ω h·ªèi th√™m (chip b√™n d∆∞·ªõi c√¢u tr·∫£ l·ªùi) */
    .suggest{ margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; }
    .suggest .chip{ padding:6px 10px; font-size:13px; border:1px solid var(--line); background:#fff; border-radius:999px; cursor:pointer; }
    .suggest .chip:hover{ background:#f8fafc; }

    /* FOOT MENU */
    .footbar{
      margin-top:14px;background:var(--soft);border:1px solid var(--line);border-radius:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;
    }
    .fb-left{display:flex;align-items:center;gap:10px;}
    .fb-right{display:flex;align-items:center;gap:8px;}
    .mini-btn,.mini-icon{
      padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font:13px/1 system-ui;
    }
    .mini-icon{width:38px;height:38px;display:inline-grid;place-items:center;}
    .mini-icon.primary{background:var(--brand);color:#fff;border-color:transparent;}
    .tip{font-size:12px;color:#666;}
    .kbd{display:inline-block;border:1px solid #ddd;border-bottom-width:2px;border-radius:6px;padding:2px 6px;background:#fff;margin:0 2px;font-size:12px;}
    @media (max-width:720px){ .tip{display:none;} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="hero">
      <picture>
        <source srcset="./logo.svg" type="image/svg+xml" />
        <img src="./logo.png" alt="Ph√°p B·∫£o Ph√∫c L·∫°c" class="brand-logo" />
      </picture>
      <h1>PH√ÅP B·∫¢O PH√öC L·∫†C ‚Äì CHATBOT</h1>
      <div class="mantra">‚ÄúT·ª´ h√≤a ‚Äì Ch√°nh ki·∫øn ‚Äì L·ª£i l·∫°c‚Äù</div>
      <div class="sub">Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t ¬∑ ‚ÄúHi·ªÉu s√¢u Ch√°nh Ph√°p ‚Äì H∆∞·ªõng ƒë·∫°o tu t·∫≠p‚Äù</div>
    </div>

    <!-- L·ªùi ch√†o + chips -->
    <div class="card" style="padding:18px;margin-bottom:10px;text-align:center;">
      <div style="font-weight:600;">Xin ch√†o b·∫°n! B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?</div>
      <div class="chips" id="chips">
        <button class="chip" data-topic="Gi√°o l√Ω">ü™∑ Gi√°o l√Ω</button>
        <button class="chip" data-topic="Kinh vƒÉn">üìú Kinh vƒÉn</button>
        <button class="chip" data-topic="S√°ch n√≥i Ph·∫≠t gi√°o">üéß S√°ch n√≥i Ph·∫≠t gi√°o</button>
        <button class="chip" data-topic="V·∫•n ƒë√°p">üí¨ V·∫•n ƒë√°p</button>
        <button class="chip" data-topic="L·ªô tr√¨nh tu h·ªçc">üõ§Ô∏è L·ªô tr√¨nh</button>
        <button class="chip" data-topic="T√¨m ph√°p tho·∫°i">üîé T√¨m ph√°p tho·∫°i</button>
      </div>
    </div>

    <!-- Chat -->
    <form id="chat-form" class="card" autocomplete="off">
      <div id="messages" aria-live="polite"></div>

      <div class="toolbar">
        <button id="clear-btn" class="tb-btn" title="X√≥a to√†n b·ªô h·ªôi tho·∫°i">X√≥a</button>
        <button id="regen-btn" class="tb-btn" title="H·ªèi l·∫°i v·ªõi c√πng c√¢u h·ªèi">L√†m m·ªõi</button>
        <button id="stop-btn" class="tb-btn" style="display:none" title="D·ª´ng ph√°t">D·ª´ng</button>
      </div>

      <div class="composer">
        <input id="chat-input" name="message" placeholder="Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t üôè B·∫°n mu·ªën h·ªèi ƒëi·ªÅu g√¨?" />
        <button id="send-btn" type="submit">G·ª≠i</button>
      </div>
    </form>

    <!-- FOOT MENU -->
    <div class="footbar">
      <div class="fb-left">
        <button id="newchat-btn" class="mini-btn">Ôºã New Chat</button>
        <span class="tip">B·∫•m <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Shift</span> + <span class="kbd">K</span> ƒë·ªÉ b·∫Øt ƒë·∫ßu cu·ªôc h·ªôi tho·∫°i m·ªõi.</span>
      </div>
      <div class="fb-right">
        <button id="stepback-btn" class="mini-icon" title="L√πi m·ªôt b∆∞·ªõc" aria-label="L√πi m·ªôt b∆∞·ªõc">‚Æå</button>
        <button id="copy-btn" class="mini-icon" title="Sao ch√©p h·ªôi tho·∫°i" aria-label="Sao ch√©p">üìã</button>
        <button id="save-btn" class="mini-icon" title="L∆∞u (.md)" aria-label="L∆∞u">üíæ</button>
        <button id="print-btn" class="mini-icon primary" title="In ra PDF" aria-label="In/PDF">‚§¥</button>
      </div>
    </div>

    <div class="hint">M·∫πo: <b>Enter</b> ƒë·ªÉ g·ª≠i, <b>Shift+Enter</b> ƒë·ªÉ xu·ªëng d√≤ng. N·∫øu trang ch·∫≠m sau v√†i ng√†y d√πng, h·ªá th·ªëng s·∫Ω t·ª± r√∫t g·ªçn l·ªãch s·ª≠ hi·ªÉn th·ªã ƒë·ªÉ nh·∫π m√°y.</div>
  </div>

  <!-- Markdown + XSS sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
  /* ===== C·∫§U H√åNH ===== */
  const API_URL        = '/api/chat';
  const API_URL_STREAM = '/api/chat-stream';
  const MAX_NODES = 120, TRIM_BATCH = 20;
  const ENABLE_GREETING_BUBBLE = false;

  /* ===== THAM CHI·∫æU ===== */
  const form   = document.getElementById('chat-form');
  const pane   = document.getElementById('messages');
  const input  = document.getElementById('chat-input');
  const send   = document.getElementById('send-btn');
  const stopBtn  = document.getElementById('stop-btn');
  const regenBtn = document.getElementById('regen-btn');
  const clearBtn = document.getElementById('clear-btn');

  const newChatBtn  = document.getElementById('newchat-btn');
  const stepBackBtn = document.getElementById('stepback-btn');
  const copyBtn     = document.getElementById('copy-btn');
  const saveBtn     = document.getElementById('save-btn');
  const printBtn    = document.getElementById('print-btn');

  const chipsBox = document.getElementById('chips');
  let activeTopic = '';

  /* ===== TI·ªÜN √çCH ===== */
  function appendBubble(text, who='assistant'){
    const el = document.createElement('div');
    el.className = 'bubble ' + (who==='user' ? 'user' : 'assistant');
    el.textContent = text ?? '';
    el.dataset.md = text || '';
    pane.appendChild(el);

    if (pane.children.length > MAX_NODES) {
      for (let i=0;i<TRIM_BATCH;i++) if (pane.firstChild) pane.removeChild(pane.firstChild);
      if (!pane.dataset.truncated) {
        const note = document.createElement('div');
        note.className = 'bubble note';
        note.textContent = 'ƒê√£ r√∫t g·ªçn l·ªãch s·ª≠ hi·ªÉn th·ªã ƒë·ªÉ trang m∆∞·ª£t h∆°n.';
        pane.insertBefore(note, pane.firstChild);
        pane.dataset.truncated = '1';
      }
    }
    pane.scrollTop = pane.scrollHeight;
    return el;
  }

  function extractSuggestions(markdown){
    const lines = (markdown || '').split('\n');
    let inSug = false, body = [], sug = [];
    for (let i=0;i<lines.length;i++){
      const L = lines[i];
      if (!inSug && /g·ª£i √Ω h·ªèi th√™m/i.test(L)) { inSug = true; continue; }
      if (inSug) {
        const m = L.trim().match(/^[-‚Ä¢]\s+(.*)/);
        if (m) { sug.push(m[1].trim()); continue; }
        if (L.trim()==='') continue;
      }
      if (!inSug) body.push(L);
    }
    return { body: body.join('\n').trim(), suggestions: sug.slice(0,5) };
  }

  function finalizeAsMarkdown(bubbleEl, text){
    const { body, suggestions } = extractSuggestions(text);
    const html = DOMPurify.sanitize(marked.parse(body || text || ''));
    bubbleEl.innerHTML = html;
    bubbleEl.dataset.md = text || '';
    bubbleEl.classList.add('assistant');

    if (suggestions.length){
      const wrap = document.createElement('div');
      wrap.className = 'suggest';
      suggestions.forEach(s=>{
        const b = document.createElement('button');
        b.type='button'; b.className='chip'; b.textContent=s;
        b.addEventListener('click', ()=>{ input.value = s; form.requestSubmit(); });
        wrap.appendChild(b);
      });
      bubbleEl.appendChild(wrap);
    }
  }

  function setBusy(b){
    send.disabled = b; input.readOnly = b;
    if (b) { send.dataset._t = send.textContent; send.textContent = 'ƒêang g·ª≠i‚Ä¶'; stopBtn.style.display='inline-block'; }
    else   { send.textContent = send.dataset._t || 'G·ª≠i'; stopBtn.style.display='none'; }
  }

  /* ===== STREAM ===== */
  let currentController = null;
  async function streamAPI(message, history, onToken, onDone){
    currentController = new AbortController();
    const res = await fetch(API_URL_STREAM, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message, history }), signal: currentController.signal
    });
    const ct = res.headers.get('content-type') || '';
    if (!res.ok) {
      const t = ct.includes('application/json') ? JSON.stringify(await res.json(), null, 2) : await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
    }
    if (!ct.includes('text/event-stream')) {
      const reply = await callAPI(message, history); onToken && onToken(reply, reply); onDone && onDone(reply); return;
    }
    const reader = res.body.getReader(); const decoder = new TextDecoder('utf-8');
    let buffer = '', acc = '';
    try{
      while(true){
        const {value, done} = await reader.read(); if (done) break;
        buffer += decoder.decode(value, {stream:true});
        const events = buffer.split('\n\n'); buffer = events.pop() || '';
        for (const evt of events){
          const lines = evt.split('\n').filter(Boolean);
          for (const line of lines){
            if (!line.startsWith('data:')) continue;
            const data = line.slice(5).trim();
            if (data === '[DONE]'){ onDone && onDone(acc); return; }
            try {
              const j = JSON.parse(data);
              const token = j?.choices?.[0]?.delta?.content || '';
              if (token){ acc += token; onToken && onToken(acc, token); }
            } catch {}
          }
        }
      }
      onDone && onDone(acc);
    } finally { currentController = null; }
  }
  function stopStream(){ if(currentController){ currentController.abort(); currentController=null; } }

  /* ===== Fallback JSON ===== */
  async function callAPI(message, history){
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ message, history }) });
    const ct = res.headers.get('content-type') || '';
    if (!res.ok){
      const t = ct.includes('application/json') ? JSON.stringify(await res.json(), null, 2) : await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
    }
    if (ct.includes('application/json')){
      const data = await res.json();
      return data?.reply || data?.choices?.[0]?.message?.content || JSON.stringify(data, null, 2);
    }
    return await res.text();
  }

  /* ===== H√ÄNH VI G·ª¨I TIN ===== */
  chipsBox?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    chipsBox.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    activeTopic = (activeTopic === btn.dataset.topic) ? '' : btn.dataset.topic;
    if (activeTopic) btn.classList.add('active');
  });

  let lastUserMsg = '';
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    try{
      const msg = (input.value || '').trim(); if (!msg) return;
      lastUserMsg = msg;
      const msgWithTopic = activeTopic ? `[Ch·ªß ƒë·ªÅ ∆∞u ti√™n: ${activeTopic}] ${msg}` : msg;

      appendBubble(msg,'user');
      input.value=''; setBusy(true);

      const history = Array.from(pane.querySelectorAll('.bubble'))
        .slice(-50)
        .map(el => ({ role: el.classList.contains('user') ? 'user' : 'assistant', content: el.dataset.md || el.textContent || '' }));

      const botBubble = appendBubble('', 'assistant');

      await streamAPI(msgWithTopic, history,
        acc => { botBubble.textContent = acc; botBubble.dataset.md = acc; pane.scrollTop = pane.scrollHeight; },
        full => { finalizeAsMarkdown(botBubble, full); });

    }catch(err){
      console.error('[Chat][Submit]', err);
      appendBubble('L·ªói: ' + (err?.message || err), 'assistant');
    }finally{
      setBusy(false); input.focus();
    }
  });

  input.addEventListener('keydown', (e)=>{
    if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }
  });

  /* ===== FOOT MENU ===== */
  function bubblesToMarkdown(){
    const out=[]; pane.querySelectorAll('.bubble').forEach(el=>{
      const role = el.classList.contains('user')?'Ng∆∞·ªùi h·ªèi':'Tr·ª£ l√Ω';
      const md   = (el.dataset.md || el.textContent || '').trim();
      out.push(`**${role}:**\n\n${md}\n`);
    }); return out.join('\n').trim()+'\n';
  }
  function saveFile(filename,content,mime='text/plain'){
    const blob=new Blob([content],{type:mime}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},100);
  }
  function ymdhs(){const d=new Date(),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;}

  function newChat(){ pane.innerHTML=''; if(ENABLE_GREETING_BUBBLE) greet(); lastUserMsg=''; }
  function stepBack(){
    const items=Array.from(pane.querySelectorAll('.bubble')); if(!items.length) return;
    let last=items.pop(); last.remove();
    if(items.length){ let prev=items.pop(); if(prev && prev.classList.contains('user')) prev.remove(); }
  }
  async function copyTranscript(){ try{ await navigator.clipboard.writeText(bubblesToMarkdown()); }catch{} }
  function saveMarkdown(){ saveFile(`PBPL_Chat_${ymdhs()}.md`, bubblesToMarkdown(), 'text/markdown'); }
  function printPDF(){
    const html='<!doctype html><html><head><meta charset="utf-8"><title>PBPL Chat '+ymdhs()+'</title><style>body{font:15px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111;}h1{font-size:20px;margin:0 0 12px}.msg{margin:10px 0;padding:10px 12px;border-radius:10px;border:1px solid #eee}.who{font-weight:700;margin-bottom:6px}</style></head><body><h1>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äì Chatbot</h1>'
      + Array.from(pane.querySelectorAll('.bubble')).map(el=>{
        const who=el.classList.contains('user')?'Ng∆∞·ªùi h·ªèi':'Tr·ª£ l√Ω';
        const md=(el.dataset.md||el.textContent||'').replace(/</g,'&lt;').replace(/\n/g,'<br>');
        return `<div class="msg"><div class="who">${who}</div><div>${md}</div></div>`;
      }).join('') + '</body></html>';
    const w=window.open('','_blank'); if(!w) return; w.document.open(); w.document.write(html); w.document.close(); w.focus(); w.print();
  }

  newChatBtn.addEventListener('click', newChat);
  stepBackBtn.addEventListener('click', stepBack);
  copyBtn.addEventListener('click', copyTranscript);
  saveBtn.addEventListener('click', saveMarkdown);
  printBtn.addEventListener('click', printPDF);

  stopBtn.addEventListener('click', ()=> stopStream());
  regenBtn.addEventListener('click', ()=>{ if(!lastUserMsg) return; input.value=lastUserMsg; form.requestSubmit(); });
  clearBtn.addEventListener('click', newChat);

  function greet(){ if (ENABLE_GREETING_BUBBLE) appendBubble('Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t! B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?'); }
  if (ENABLE_GREETING_BUBBLE) greet();

  console.log('[Chat] Ready ‚úÖ');
  </script>
</body>
</html>
