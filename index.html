<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</title>
  <meta name="description" content="Ph√°p B·∫£o Ph√∫c L·∫°c Chatbot ‚Äî H·ªèi ƒëi·ªÅu b·∫°n mu·ªën h·ªçc h√¥m nay." />
  <link rel="icon" type="image/png" href="/logo.png" />
  <meta property="og:image" content="https://pbpl-vercel.vercel.app/logo.png" />

  <style>
    :root{
      /* THU·∫¶N X√ÅM ‚Äì ƒêEN */
      --bg:#f5f5f5;          /* n·ªÅn ngo√†i */
      --surface:#ffffff;     /* th·∫ª */
      --ink:#222;            /* ch·ªØ ch√≠nh */
      --muted:#666;          /* ch·ªØ ph·ª• */
      --soft:#f2f4f7;        /* bong b√≥ng assistant */
      --line:#e6e6e6;        /* vi·ªÅn nh·∫°t */
      --btn:#222;            /* n√∫t ch√≠nh: ƒëen */
      --ring:rgba(0,0,0,.08);/* vi·ªÅn focus */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}

    .wrap{max-width:900px;margin:28px auto;padding:0 12px}
    .card{background:var(--surface);border-radius:20px;padding:24px;box-shadow:0 8px 30px rgba(0,0,0,.06)}

    /* HEADER ‚Äì ti√™u ƒë·ªÅ NH·ªé H∆†N & M·∫¢NH H∆†N */
    .header{display:flex;gap:16px;align-items:center;justify-content:center;text-align:center;padding:20px 12px}
    .logo{width:72px;height:72px;border-radius:50%;display:grid;place-items:center;background:#fff;border:1px solid var(--line);box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .logo img{max-width:64px;height:auto;display:block}
    .title h1{margin:0;font-size:22px;font-weight:600;color:#222;letter-spacing:.2px}   /* ‚Üì size & weight */
    .title .sub1{margin-top:6px;font-size:12px;color:#777;letter-spacing:.08em}
    .title .sub2{margin-top:4px;font-size:13px;color:#7a7a7a;font-style:italic}

    /* CHAT */
    .chat{margin-top:18px;display:flex;flex-direction:column;gap:12px;min-height:60vh}
    .greeting{color:#222;background:#fafafa;border:1px solid var(--line);padding:10px 12px;border-radius:12px;font-size:14px}
    /* (ƒë√£ b·ªè emoji) */

    .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:6px}
    .msg{display:flex;gap:10px;align-items:flex-start}
    .bubble{max-width:820px;padding:12px 14px;border-radius:14px;line-height:1.6;font-size:15px;box-shadow:0 2px 12px rgba(0,0,0,.04)}
    .assistant .bubble{background:var(--soft)}
    .user{justify-content:flex-end}
    .user .bubble{background:#fcfcfc;border:1px solid var(--line)} /* x√°m nh·∫°t, kh√¥ng c√≤n h·ªìng */

    /* COMPOSER + TOOLBAR */
    .composer{position:sticky;bottom:0;background:var(--surface);padding-top:8px}
    .form{display:flex;gap:10px;align-items:flex-end}
    .box{flex:1;position:relative}
    textarea{
      width:100%;min-height:64px;max-height:260px;resize:vertical;
      padding:16px 52px 16px 16px;  /* ‚Üë tƒÉng kho·∫£ng c√°ch trong √¥ nh·∫≠p */
      border-radius:14px;border:1px solid var(--line);outline:none;
      font-size:15px;line-height:1.55;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.04)
    }
    textarea:focus{border-color:#bbb;box-shadow:0 0 0 4px var(--ring)}
    .send{border:none;background:var(--btn);color:#fff;padding:12px 18px;border-radius:14px;font-weight:700;cursor:pointer}
    .send:disabled{opacity:.6;cursor:not-allowed}

    .tools{display:flex;flex-wrap:wrap;gap:8px;justify-content:flex-end;margin-top:10px}
    .btn{border:1px solid var(--line);background:#fff;color:#222;padding:8px 10px;border-radius:10px;font-size:13px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .status{margin-top:6px;color:var(--muted);font-size:12px}
    .error{color:#b00000}

    .topbtn{position:fixed;right:18px;bottom:18px;width:42px;height:42px;border-radius:999px;border:1px solid var(--line);
      display:grid;place-items:center;background:#fff;color:#222;box-shadow:0 6px 20px rgba(0,0,0,.12);cursor:pointer}

    @media (max-width:640px){.wrap{margin:16px auto}.title h1{font-size:20px}}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="card header">
      <div class="logo"><img src="/logo.png" alt="Ph√°p B·∫£o Ph√∫c L·∫°c"></div>
      <div class="title">
        <h1>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</h1>
        <div class="sub1">NAM M√î B·ªîN S∆Ø TH√çCH CA M√ÇU NI PH·∫¨T</div>
        <div class="sub2">‚ÄúHi·ªÉu s√¢u Ch√°nh Ph√°p ‚Äì H∆∞·ªõng ƒë·∫°o tu t·∫≠p‚Äù</div>
      </div>
    </div>

    <!-- Chat -->
    <div class="card chat" role="region" aria-label="Khu v·ª±c h·ªôi tho·∫°i">
      <div class="greeting">Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t. B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?</div>

      <div id="messages" class="messages" aria-live="polite" aria-busy="false"></div>

      <div class="composer">
        <form id="composer" class="form" autocomplete="off">
          <div class="box">
            <label class="sr-only" for="input">Nh·∫≠p c√¢u h·ªèi...</label>
            <textarea id="input" placeholder="G√µ c√¢u h·ªèi c·ªßa b·∫°n‚Ä¶ (Shift+Enter xu·ªëng d√≤ng)" rows="3"></textarea>
          </div>
          <button class="send" id="send" type="submit">G·ª≠i</button>
        </form>

        <div class="tools">
          <button class="btn" id="copyAnswer" title="Sao ch√©p c√¢u tr·∫£ l·ªùi m·ªõi nh·∫•t">üìã Sao ch√©p c√¢u tr·∫£ l·ªùi</button>
          <button class="btn" id="shareAnswer" title="Chia s·∫ª c√¢u tr·∫£ l·ªùi">üîó Chia s·∫ª</button>
          <button class="btn" id="downloadTxt" title="T·∫£i h·ªôi tho·∫°i .txt">‚¨áÔ∏è T·∫£i .txt</button>
        </div>
        <div class="status" id="status">S·∫µn s√†ng.</div>
      </div>
    </div>
  </div>

  <a class="topbtn" href="#" id="topBtn" title="L√™n ƒë·∫ßu trang">‚ñ≤</a>

  <script>
    /* Gi·ªõi h·∫°n & ƒë·ªô tr·ªÖ ƒë·ªÉ ti·∫øt ki·ªám chi ph√≠ (gi·ªØ nh∆∞ b·∫£n tr∆∞·ªõc) */
    const MAX_CHARS = 500;
    const COOLDOWN_MS = 4000;

    const CONFIG = {
      SERVER_URL: '/api/chat',
      SYSTEM_PROMPT: `B·∫°n l√† Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äî tr·ª£ l√Ω Ph·∫≠t h·ªçc t·ª´ bi, khi√™m cung, tr·∫£ l·ªùi r√µ r√†ng, ng·∫Øn g·ªçn, c√≥ tr√≠ch d·∫´n khi ph√π h·ª£p; gi·ªØ ch√°nh ki·∫øn.`
    };

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const formEl = document.getElementById('composer');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const copyBtn = document.getElementById('copyAnswer');
    const shareBtn = document.getElementById('shareAnswer');
    const downloadBtn = document.getElementById('downloadTxt');

    const STORAGE_KEY = 'pbpl_chat_v4';
    let chat = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!chat.length) chat = [{ role:'system', content: CONFIG.SYSTEM_PROMPT }];

    let lastSentAt = 0;

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chat)); }
    function esc(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
    function toHTML(t){
      t = esc(t).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br/>');
      return t.replace(/(https?:\/\/[^\s]+)/g,'<a target="_blank" rel="noopener">$1</a>');
    }
    function render(){
      messagesEl.innerHTML='';
      for(const m of chat){ if(m.role==='system') continue;
        const row=document.createElement('div'); row.className='msg '+(m.role==='assistant'?'assistant':'user');
        const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=toHTML(m.content);
        row.appendChild(bubble); messagesEl.appendChild(row);
      }
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    render();

    document.getElementById('topBtn').addEventListener('click', e=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); });
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); formEl.dispatchEvent(new Event('submit')); }});

    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const text = inputEl.value.trim(); if(!text) return;

      if (text.length > MAX_CHARS) { setStatus(`C√¢u h·ªèi qu√° d√†i (${text.length}/${MAX_CHARS}). Vui l√≤ng r√∫t g·ªçn.`, true); return; }
      const now = Date.now(), remain = COOLDOWN_MS - (now - lastSentAt);
      if (remain > 0) { setStatus(`Vui l√≤ng ƒë·ª£i ${Math.ceil(remain/1000)} gi√¢y tr∆∞·ªõc khi g·ª≠i ti·∫øp.`, true); return; }
      lastSentAt = now;

      inputEl.value='';
      chat.push({ role:'user', content:text }); save(); render(); setBusy(true);

      try{
        const res = await fetch(CONFIG.SERVER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ messages: chat }) });
        if(!res.ok) throw new Error('Bad response: '+res.status);
        const data = await res.json();

        const full = data.reply || '';
        chat.push({ role:'assistant', content:'' }); save(); render();
        let acc=''; for(let i=0;i<full.length;i++){ acc+=full[i]; chat[chat.length-1].content=acc;
          if(i%3===0){ save(); render(); await new Promise(r=>setTimeout(r,8)); } }
        setStatus('ƒê√£ tr·∫£ l·ªùi.');
      }catch(err){
        chat.push({ role:'assistant', content:'Xin l·ªói, h·ªá th·ªëng ƒëang b·∫≠n ho·∫∑c API ch∆∞a s·∫µn s√†ng.' });
        setStatus('C√≥ l·ªói khi g·ªçi API.', true);
      } finally{ setBusy(false); save(); render(); }
    });

    function setBusy(b){ sendBtn.disabled=b; statusEl.textContent = b? 'ƒêang tr·∫£ l·ªùi‚Ä¶' : 'S·∫µn s√†ng.'; }
    function setStatus(msg, isError=false){
      statusEl.textContent = msg; statusEl.className = 'status' + (isError ? ' error' : '');
      if(isError){ setTimeout(()=>{ statusEl.textContent='S·∫µn s√†ng.'; statusEl.className='status'; }, 4000); }
    }

    // Tools: copy / share / download
    function getLastAssistant(){ for(let i=chat.length-1;i>=0;i--){ if(chat[i].role==='assistant') return chat[i].content; } return ''; }
    function plainConversation(){
      return chat.filter(x=>x.role!=='system').map(x=> (x.role==='user'?'B·∫°n: ':'Chatbot: ')+x.content).join('\n\n');
    }
    copyBtn.addEventListener('click', async ()=>{
      const text=getLastAssistant(); if(!text){ setStatus('Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi ƒë·ªÉ sao ch√©p.', true); return; }
      await navigator.clipboard.writeText(text); setStatus('ƒê√£ sao ch√©p c√¢u tr·∫£ l·ªùi.');
    });
    shareBtn.addEventListener('click', async ()=>{
      const text=getLastAssistant()||'Ph√°p B·∫£o Ph√∫c L·∫°c Chatbot'; const data={title:'Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot',text, url:location.href};
      if(navigator.share){ try{ await navigator.share(data); setStatus('ƒê√£ m·ªü h·ªôp tho·∫°i chia s·∫ª.'); } catch{ setStatus('Chia s·∫ª b·ªã h·ªßy.', true); } }
      else { await navigator.clipboard.writeText(`${data.title}\n\n${text}\n\n${data.url}`); setStatus('Thi·∫øt b·ªã kh√¥ng h·ªó tr·ª£ chia s·∫ª ‚Äî ƒë√£ sao ch√©p.'); }
    });
    downloadBtn.addEventListener('click', ()=>{
      const content=plainConversation(); if(!content.trim()){ setStatus('Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ t·∫£i.', true); return; }
      const blob=new Blob([content],{type:'text/plain;charset=utf-8'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); const ts=new Date().toISOString().slice(0,19).replace(/[T:]/g,'-');
      a.href=url; a.download=`PBPL-chat-${ts}.txt`; a.click(); URL.revokeObjectURL(url); setStatus('ƒê√£ t·∫£i h·ªôi tho·∫°i (.txt).');
    });
  </script>
</body>
</html>
