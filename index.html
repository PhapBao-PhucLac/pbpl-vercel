<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pháp Bảo Phúc Lạc • Chatbot</title>
  <link rel="icon" href="logo.png" />
  <style>
    :root{
      --bg:#ffffff; --ink:#101828; --muted:#6b7280; --line:#e5e7eb;
      --bubble:#f8fafc; --brand:#111827; --accent:#111827;
      --radius:14px; --maxw:980px;
    }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0; background:var(--bg); color:var(--ink); font:16px/1.65 system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif }
    .wrap{ max-width:var(--maxw); margin:auto; padding:24px 16px 96px }

    /* Header */
    .hero{ display:flex; align-items:center; gap:16px; padding:12px 0 8px; border-bottom:1px solid var(--line) }
    .hero img{ width:56px; height:56px; border-radius:50% }
    .hero h1{ margin:0; font-size:22px; font-weight:700; letter-spacing:.2px }
    .hero small{ display:block; color:var(--muted); margin-top:4px }

    /* Lời chào */
    .greet{ margin:14px 0 10px; padding:12px 14px; border:1px solid var(--line); border-radius:12px; color:var(--muted) }

    /* Toolbar nhanh */
    .bar{ display:flex; gap:10px; flex-wrap:wrap; margin:8px 0 14px }
    .icon-btn{ height:36px; padding:0 12px; border:1px solid var(--line); background:#fff; border-radius:10px; display:inline-flex; align-items:center; gap:8px; color:#111; cursor:pointer; transition:.15s transform }
    .icon-btn:hover{ transform:translateY(-1px) }
    .icon{ width:18px; height:18px; display:inline-block; color:#6b7280 }
    .icon svg{ width:100%; height:100% }

    /* Khung chat */
    .chat{ display:flex; flex-direction:column; gap:12px; margin:12px 0 18px }
    .msg{ background:var(--bubble); border:1px solid var(--line); border-radius:12px; padding:14px }
    .me{ background:#eef2ff; border-color:#e0e7ff }
    .meta{ font-size:12px; color:var(--muted); margin-bottom:6px }

    /* Compose */
    .inputbar{ position:sticky; bottom:0; left:0; right:0; background:var(--bg) }
    .composer{ border:1px solid var(--line); border-radius:12px; padding:10px; display:flex; gap:10px }
    .composer textarea{ flex:1; min-height:44px; max-height:220px; resize:vertical; border:0; outline:0; font:inherit; line-height:1.6 }
    .send{ width:42px; height:42px; border-radius:10px; border:1px solid var(--line); background:#111; color:#fff; display:inline-flex; align-items:center; justify-content:center; cursor:pointer }
    .send:disabled{ opacity:.6; cursor:not-allowed }

    /* Nút nổi New Chat */
    .btn-new{ position:fixed; bottom:18px; right:18px; z-index:1000; width:56px; height:56px; border-radius:14px; background:#111827; color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 8px 22px rgba(0,0,0,.15); border:0; cursor:pointer }
    .btn-new svg{ width:22px; height:22px }
    .hint{ text-align:right; color:var(--muted); font-size:12px; margin-top:6px }
    .sr{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="hero">
      <img src="logo.png" alt="PBPL logo">
      <div>
        <h1>Pháp Bảo Phúc Lạc • Chatbot</h1>
        <small>NAM MÔ BỔN SƯ THÍCH CA MÂU NI PHẬT — “Hiểu sâu Chánh Pháp – Hướng đạo tu tập”</small>
      </div>
    </header>

    <div class="greet">Nam mô Bổn Sư Thích Ca Mâu Ni Phật. Bạn đang muốn tìm hiểu điều gì trong Phật pháp?</div>

    <!-- Thanh chọn nhanh (icon nhạt) -->
    <div class="bar" id="quickbar">
      <button class="icon-btn" data-q="Giải thích giúp tôi giáo lý Tứ Diệu Đế một cách rõ ràng, có ví dụ thực hành.">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M4 7h16M4 12h16M4 17h10"/></svg>
        </span>Giáo lý
      </button>
      <button class="icon-btn" data-q="Trích một đoạn kinh ngắn (có nguồn) và giải thích ý chính thật dễ hiểu.">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19V5a2 2 0 0 1 2-2h10l4 4v12a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"/><path d="M14 3v4h4"/></svg>
        </span>Kinh văn
      </button>
      <button class="icon-btn" data-q="Gợi ý sách nói/MP3 Phật học dễ nghe cho người mới bắt đầu (kèm đường dẫn).">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="19" r="3"/><circle cx="18" cy="19" r="3"/><path d="M9 19V6H5v13M9 6l10-2v15"/></svg>
        </span>Sách nói / MP3
      </button>
      <button class="icon-btn" data-q="Mình đang băn khoăn điều này trong tu tập: … Xin tư vấn từng bước, có ví dụ.">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h.01"/><path d="M2 12a10 10 0 1 1 20 0"/><path d="M12 16v-2a4 4 0 1 0-4-4"/></svg>
        </span>Hỏi đáp
      </button>
      <button class="icon-btn" data-q="Mình mới bắt đầu. Xin một lộ trình tu học theo cấp độ (7–14–30 ngày).">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M7 13l3 3 7-7"/></svg>
        </span>Lộ trình
      </button>
      <button class="icon-btn" data-q="Tìm pháp thoại phù hợp về chủ đề: chánh niệm nơi công sở (kèm đường dẫn).">
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        </span>Tìm pháp thoại
      </button>
    </div>

    <main id="messages" class="chat" aria-live="polite" aria-busy="false"></main>

    <div class="inputbar">
      <form id="form" class="composer">
        <label for="ta" class="sr">Nhập câu hỏi</label>
        <textarea id="ta" placeholder="Gõ câu hỏi của bạn… (Shift+Enter xuống dòng)"></textarea>
        <button id="send" class="send" type="submit" title="Gửi">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M22 2L11 13"/><path d="M22 2l-7 20-4-9-9-4 20-7z"/></svg>
          <span class="sr">Gửi</span>
        </button>
      </form>
      <div class="hint">Bấm <b>New Chat</b> hoặc phím tắt <b>Ctrl/Cmd + Shift + K</b> để bắt đầu cuộc hội thoại mới.</div>
    </div>
  </div>

  <!-- Nút nổi New Chat -->
  <button id="newchat" class="btn-new" title="New Chat (Ctrl/Cmd+Shift+K)" aria-label="New Chat">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
  </button>

  <script>
    // --------- State ----------
    const history = [];      // {role, content}
    const ta = document.getElementById('ta');
    const form = document.getElementById('form');
    const list = document.getElementById('messages');

    // --------- Helpers ----------
    const el = (html) => {
      const div = document.createElement('div');
      div.innerHTML = html.trim();
      return div.firstElementChild;
    };
    function addUser(text){
      list.appendChild(el(`<section class="msg me"><div class="meta">Bạn</div><div>${escapeHtml(text)}</div></section>`));
      list.scrollTop = list.scrollHeight;
    }
    function addBot(text){
      list.appendChild(el(`<section class="msg"><div class="meta">Pháp Bảo Chatbot</div><div>${renderMarkdown(text)}</div></section>`));
      list.scrollTop = list.scrollHeight;
    }
    function escapeHtml(s){
      return s.replace(/[&<>]/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c]));
    }
    // rất gọn: xuống dòng -> <br>, gạch đầu dòng cơ bản
    function renderMarkdown(s){
      return escapeHtml(s)
        .replace(/^(\s*)[-*]\s+/gm,'$1• ')
        .replace(/\n/g,'<br>');
    }

    // --------- Send ----------
    async function send(q){
      const text = (q ?? ta.value).trim();
      if(!text) return;
      ta.value = '';
      addUser(text);
      history.push({ role:'user', content:text });

      const btn = document.getElementById('send');
      btn.disabled = true; list.setAttribute('aria-busy','true');

      try{
        const r = await fetch('/api/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ messages: [ {role:'system', content: baseSystem()},
                                             ...history ] })
        });
        if(!r.ok){
          const t = await r.text();
          addBot('Xin lỗi, hệ thống bận hoặc API chưa sẵn sàng.\n\nChi tiết: ' + t.slice(0,200));
          return;
        }
        const data = await r.json();
        const reply = (data.reply || '').trim();
        history.push({ role:'assistant', content: reply });
        addBot(reply || 'Mình chưa nhận được nội dung trả lời.');
      }catch(err){
        addBot('Xin lỗi, có lỗi kết nối. Vui lòng thử lại.');
      }finally{
        btn.disabled = false; list.setAttribute('aria-busy','false');
        ta.focus();
      }
    }

    // System prompt “đậm đà” hơn (temperature do API set, đây là “tone”)
    function baseSystem(){
      return [
        'Bạn là Pháp Bảo Phúc Lạc — trợ lý Phật học từ bi, khiêm cung, rõ ràng.',
        'Phong cách: ấm áp, gợi mở, có ví dụ thực hành ngắn, tôn trọng truyền thống.',
        'Ưu tiên câu trả lời 220–320 từ khi phù hợp; có gạch đầu dòng rõ.',
        'Nếu người dùng cần sâu thêm, đề nghị các bước kế tiếp, hoặc nguồn tra cứu.'
      ].join(' ');
    }

    // Submit
    form.addEventListener('submit', (e)=>{ e.preventDefault(); send(); });
    ta.addEventListener('keydown', (e)=>{
      if(e.key==='Enter' && !e.shiftKey){
        e.preventDefault(); send();
      }
    });

    // Quick bar
    document.getElementById('quickbar').addEventListener('click', (e)=>{
      const b = e.target.closest('button[data-q]');
      if(!b) return;
      send(b.dataset.q);
    });

    // New Chat + phím tắt
    function resetChat(){
      history.length = 0;
      list.innerHTML = '';
      ta.value = '';
      ta.focus();
    }
    document.getElementById('newchat').addEventListener('click', resetChat);
    window.addEventListener('keydown', (e)=>{
      const mod = e.ctrlKey || e.metaKey;
      if(mod && e.shiftKey && (e.key==='K' || e.key==='k')){
        e.preventDefault(); resetChat();
      }
    });
  </script>
</body>
</html>
