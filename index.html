<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Pháp Bảo Phúc Lạc • Chatbot</title>

<link rel="icon" href="/logo.png">
<link rel="stylesheet" href="/styles.css"/>

<meta property="og:title" content="Pháp Bảo Phúc Lạc • Chatbot"/>
<meta property="og:description" content="Hiểu sâu Chánh Pháp – Hướng đạo tu tập."/>
<meta property="og:image" content="/logo.png"/>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="hero">
      <img src="/logo.png" alt="Logo PBPL" class="logo"/>
      <div>
        <h1>Pháp Bảo Phúc Lạc • Chatbot</h1>
        <small>NAM MÔ BỔN SƯ THÍCH CA MÂU NI PHẬT — “Hiểu sâu Chánh Pháp – Hướng đạo tu tập”</small>
      </div>
    </header>

    <!-- Chào + dãy icon -->
    <div class="greet">Nam mô Bổn Sư Thích Ca Mâu Ni Phật. Bạn đang muốn tìm hiểu điều gì trong Phật pháp?</div>

    <div class="menu" id="quickMenu">
      <!-- Giáo lý -->
      <button class="icon-btn" title="Giáo lý" data-text="Giải thích giúp tôi giáo lý 'Tứ Diệu Đế' thật dễ hiểu.">
        <span class="sr">Giáo lý</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M4 19V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v13M4 19h10M8 6h6" stroke-width="1.5"/></svg>
      </button>
      <!-- Kinh văn -->
      <button class="icon-btn" title="Kinh văn" data-text="Hãy trích một đoạn kinh ngắn và giải thích ứng dụng thực tế.">
        <span class="sr">Kinh văn</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M5 4h10a3 3 0 0 1 3 3v13H8a3 3 0 0 1-3-3V4z" stroke-width="1.5"/><path d="M8 8h8M8 12h8M8 16h6" stroke-width="1.5"/></svg>
      </button>
      <!-- Sách nói / MP3 -->
      <button class="icon-btn" title="Sách nói / MP3" data-text="Gợi ý 5 pháp thoại MP3 về chánh niệm cho người mới.">
        <span class="sr">Sách nói / MP3</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="8" cy="18" r="2" stroke-width="1.5"/><circle cx="18" cy="18" r="2" stroke-width="1.5"/><path d="M6 18V6h11a1 1 0 0 1 1 1v9" stroke-width="1.5"/></svg>
      </button>
      <!-- Hỏi đáp -->
      <button class="icon-btn" title="Hỏi đáp" data-text="Giải đáp giúp tôi: Làm sao giữ chánh niệm giữa công việc bận rộn?">
        <span class="sr">Hỏi đáp</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a4 4 0 0 1-4 4H7l-4 4V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z" stroke-width="1.5"/></svg>
      </button>
      <!-- Tu học theo cấp độ -->
      <button class="icon-btn" title="Tu học theo cấp độ" data-text="Hướng dẫn lộ trình tu tập: nhập môn → căn bản → nâng cao (gợi ý bài học).">
        <span class="sr">Tu học theo cấp độ</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M3 20h18M6 16h4v4H6zm6-6h4v10h-4zm6-6h4v16h-4z" stroke-width="1.5"/></svg>
      </button>
      <!-- Tìm pháp thoại -->
      <button class="icon-btn" title="Tìm pháp thoại" data-text="Tìm pháp thoại của HT. Thích… về chủ đề từ bi (kèm đường dẫn nếu có).">
        <span class="sr">Tìm pháp thoại</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="11" cy="11" r="7" stroke-width="1.5"/><path d="m20 20-3.5-3.5" stroke-width="1.5"/></svg>
      </button>
      <!-- Câu hỏi phổ biến -->
      <button class="icon-btn" title="Câu hỏi phổ biến" data-text="Liệt kê 10 câu hỏi Phật học phổ biến cho người mới, kèm gợi ý trả lời ngắn.">
        <span class="sr">Câu hỏi phổ biến</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M7 8h10M7 12h10M7 16h8" stroke-width="1.5"/></svg>
      </button>
    </div>

    <!-- Chat Panel -->
    <section class="panel">
      <!-- New Chat -->
      <button id="newChat" class="newchat" title="Cuộc hội thoại mới">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <rect x="4" y="3" width="14" height="18" rx="2" stroke-width="1.5"/><path d="M12 8v8M8 12h8" stroke-width="1.5"/>
        </svg>
      </button>

      <div class="msgs" id="msgs"></div>

      <div class="composer">
        <textarea id="inp" maxlength="800" placeholder="Gõ câu hỏi của bạn… (Shift+Enter xuống dòng)"></textarea>
        <button class="send" id="send" title="Gửi">
          <!-- giấy bay (kiểu ChatGPT) -->
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M3 11.5 21 3l-8.5 18-2.5-7-7-2.5Z" stroke-width="1.5"/>
          </svg>
        </button>
      </div>

      <div class="actions">
        <button class="icon-btn ghost" id="copy" title="Sao chép câu trả lời">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <rect x="9" y="9" width="11" height="11" rx="2" stroke-width="1.5"/>
            <rect x="4" y="4" width="11" height="11" rx="2" stroke-width="1.5"/>
          </svg>
          <span class="sr">Sao chép câu trả lời</span>
        </button>
        <button class="icon-btn ghost" id="save" title="Tải .txt">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path d="M12 3v12m0 0 4-4m-4 4-4-4M5 21h14" stroke-width="1.5"/>
          </svg>
          <span class="sr">Tải .txt</span>
        </button>
        <span class="muted" id="hint">Sẵn sàng.</span>
      </div>
    </section>
  </div>

<script>
/* ===== Cấu hình ===== */
const SERVER_URL = '/api/chat';
const TEMPERATURE = 0.5;
const MAX_LEN = 800;
const MIN_INTERVAL_MS = 5500;

/* ===== Trạng thái ===== */
const msgsEl = document.getElementById('msgs');
const inp = document.getElementById('inp');
const sendBtn = document.getElementById('send');
const copyBtn = document.getElementById('copy');
const saveBtn = document.getElementById('save');
const newChatBtn = document.getElementById('newChat');
const hint = document.getElementById('hint');
let history = [];
let lastSentAt = 0;

/* ===== Tiện ích ===== */
function addMsg(role, text, typing=false){
  const el = document.createElement('div');
  el.className = 'msg ' + (role==='user'?'me':'ai') + (typing?' typing':'');
  el.textContent = text;
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  return el;
}
function setHint(t){ hint.textContent = t; }
function throttleOK(){
  const now = Date.now();
  if (now - lastSentAt < MIN_INTERVAL_MS) {
    const remain = Math.ceil((MIN_INTERVAL_MS - (now - lastSentAt))/1000);
    setHint(`Chờ ${remain}s để gửi câu tiếp theo (giữ chánh niệm, tiết kiệm chi phí).`);
    return false;
  }
  return true;
}

/* ===== Gửi ===== */
async function ask(q){
  if(!q.trim()) return;
  if(!throttleOK()) return;
  if(q.length>MAX_LEN){ setHint(`Câu hỏi quá dài (${q.length}/${MAX_LEN}).`); return; }

  lastSentAt = Date.now();
  addMsg('user', q);
  const aiTyping = addMsg('assistant','…',true);
  inp.value=''; setHint('Đang hỏi…'); sendBtn.disabled=true;

  const system = {role:'system',content:
    'Bạn là Pháp Bảo Phúc Lạc — trợ lý Phật học từ bi, khiêm cung, súc tích; giọng ấm, gợi mở thực hành chánh niệm. Khi phù hợp, trình bày gạch đầu dòng.'};
  const fewshots = [
    {role:'user',content:'Đạo Phật là gì vậy ạ? Con thấy nhiều người nói mà vẫn chưa hiểu rõ.'},
    {role:'assistant',content:'Dạ, cảm ơn câu hỏi rất đẹp của bạn. Đạo Phật là con đường đưa tới an lạc và giác ngộ, do Đức Phật chỉ dạy. Ngài khuyên mình quan sát thân tâm, nhận diện khổ và nguyên nhân, rồi thực hành từ bi – trí tuệ. Nếu bạn muốn, ta có thể đi lần lượt Tứ Diệu Đế và Bát Chánh Đạo.'}
  ];
  const messages=[system, ...fewshots, ...history, {role:'user',content:q}];

  try{
    const r = await fetch(SERVER_URL,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({messages})});
    if(!r.ok) throw new Error(await r.text());
    const data = await r.json();
    const reply = (data.reply||'').trim() || 'Xin lỗi, hệ thống tạm bận.';
    aiTyping.classList.remove('typing'); aiTyping.textContent = reply;
    history.push({role:'user',content:q},{role:'assistant',content:reply});
    setHint('Hoàn tất.');
  }catch(e){
    aiTyping.classList.remove('typing'); aiTyping.textContent = 'Xin lỗi, hệ thống đang bận hoặc API chưa sẵn sàng.';
    setHint('Có lỗi kết nối.');
  }finally{ sendBtn.disabled=false; }
}

/* ===== Sự kiện ===== */
sendBtn.onclick = ()=> ask(inp.value);
inp.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){e.preventDefault(); ask(inp.value);} });

document.getElementById('quickMenu').addEventListener('click',e=>{
  const btn = e.target.closest('.icon-btn'); if(!btn) return;
  inp.value = btn.dataset.text || ''; inp.focus();
});

/* Sao chép / Tải txt */
copyBtn.onclick = ()=>{
  const lastAI = [...document.querySelectorAll('.ai')].pop();
  if(!lastAI){ setHint('Chưa có câu trả lời để sao chép.'); return; }
  navigator.clipboard.writeText(lastAI.textContent);
  setHint('Đã sao chép.');
};
saveBtn.onclick = ()=>{
  const all = [...document.querySelectorAll('.msg')]
    .map(el=> (el.classList.contains('me')?'Bạn: ':'PBPL: ')+el.textContent).join('\n\n');
  const blob = new Blob([all],{type:'text/plain;charset=utf-8'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pbpl_chat.txt'; a.click();
  URL.revokeObjectURL(a.href);
};

/* New Chat */
newChatBtn.onclick = ()=>{
  history = [];
  msgsEl.innerHTML = '';
  inp.value = '';
  setHint('Bắt đầu cuộc hội thoại mới.');
  inp.focus();
};
</script>
  <script>
(function(){
  const btn = document.getElementById('newChatBtn');
  if(!btn) return;

  // các phần tử UI
  const list = document.querySelector('.msgs')       // khung tin nhắn
             || document.getElementById('messages'); // fallback nếu bạn dùng id khác
  const ta   = document.querySelector('textarea');   // ô nhập

  // Hàm reset hội thoại
  function resetChat(){
    // 1) dừng yêu cầu đang chạy (nếu bạn có streaming)
    try { window.abortController?.abort(); } catch(e){}

    // 2) xoá nội dung khung tin nhắn
    if (list) list.innerHTML = '';

    // 3) xoá lịch sử lưu local (nếu bạn có dùng)
    try {
      localStorage.removeItem('pbpl_history');
      sessionStorage.removeItem('pbpl_history');
    } catch(e){}

    // 4) xoá mảng lịch sử trong bộ nhớ (tuỳ bạn có đặt hay không)
    if (window.chatHistory) window.chatHistory = [];

    // 5) đưa con trỏ về ô nhập
    if (ta) { ta.value = ''; ta.focus(); }

    // (tuỳ chọn) hiện 1 dòng thông báo nhẹ
    if (list && list.classList.contains('msgs')) {
      const note = document.createElement('div');
      note.className = 'msg ai typing';
      note.textContent = 'Đã bắt đầu cuộc trò chuyện mới.';
      list.appendChild(note);
      list.scrollTop = list.scrollHeight;
      setTimeout(()=> note.remove(), 1400); // tự ẩn sau 1.4s
    }
  }

  // Gắn sự kiện click cho nút
  btn.addEventListener('click', resetChat);
})();
</script>
  <script>
<!-- PBPL :: New Chat (compact patch) -->
<style>
  /* Nút New Chat nổi góc dưới phải */
  .pbpl-new {
    position: fixed;
    right: 16px;          /* đổi thành left:16px; nếu muốn ở góc trái */
    bottom: 16px;
    width: 44px; height: 44px;
    display: grid; place-items: center;
    border-radius: 12px;
    background: #111;     /* nền đen nhã */
    color: #9ca3af;       /* icon xám nhạt */
    box-shadow: 0 4px 16px rgba(0,0,0,0.18);
    cursor: pointer;
    z-index: 9999;
    border: 1px solid #222;
    transition: transform .15s ease, color .15s ease, background .15s ease;
  }
  .pbpl-new:hover { color:#374151; transform: translateY(-1px); }
  .pbpl-new:active { transform: translateY(0); }
  .pbpl-new svg { width: 22px; height: 22px; }

  /* Mobile: tăng hit-area */
  @media (max-width: 640px){
    .pbpl-new{ width: 48px; height: 48px; border-radius: 14px; bottom: 20px; right: 14px; }
  }

  /* Tooltip hotkey dưới ô nhập (được chèn bằng JS) */
  .pbpl-hotkey-tip{
    margin-top: 6px; font-size: .85rem; color: #9ca3af;
    user-select: none;
  }
  .pbpl-hotkey-tip kbd{
    background:#111; color:#e5e7eb; border-radius:4px;
    padding: 1px 6px; font-size: .8rem; border:1px solid #222;
  }
</style>

<!-- Nút New Chat (SVG gọn, nét mảnh) -->
<button id="newchatbtn" class="pbpl-new" type="button" title="New Chat (Ctrl/Cmd + Shift + K)" aria-label="New Chat">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <!-- biểu tượng “tab mới” giản dị -->
    <path d="M4 7a3 3 0 0 1 3-3h5" />
    <rect x="4" y="7" width="16" height="13" rx="3"/>
    <path d="M13 4h7M20 4v7"/>
  </svg>
</button>

<script>
(function () {
  /* ====== Tìm các phần tử quan trọng ====== */
  const btn = document.getElementById('newchatbtn');

  // Vùng tin nhắn & ô nhập (cố gắng bắt chắc kể cả class khác nhau)
  const list = document.getElementById('messages')
           || document.querySelector('.messages')
           || document.querySelector('[data-messages]')
           || document.querySelector('[role="log"]')
           || document.body; // fallback an toàn (sẽ chỉ xóa nội dung chat nếu list là container đúng)
  const ta   = document.querySelector('#textarea, textarea, [data-input="message"]');

  // Chèn tooltip phím tắt dưới ô nhập (nếu chưa có)
  (function addTip(){
    if (!ta) return;
    const wrap = ta.parentElement;
    if (!wrap || wrap.querySelector('.pbpl-hotkey-tip')) return;
    const tip = document.createElement('small');
    tip.className = 'pbpl-hotkey-tip';
    tip.innerHTML = 'Mẹo: Nhấn <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>Shift</kbd> + <kbd>K</kbd> để bắt đầu hội thoại mới';
    wrap.appendChild(tip);
  })();

  /* ====== Hàm reset hội thoại ====== */
  function resetChat(options = {}) {
    const { askConfirm = true } = options;

    // 0) Khoá double click ngắn
    if (resetChat._locking) return;
    resetChat._locking = true; setTimeout(()=> resetChat._locking = false, 400);

    // 1) Nếu đang stream dở, cố gắng dừng
    try { window.abortController?.abort(); } catch(e){}

    // 2) Hỏi xác nhận (có thể tắt bằng askConfirm:false)
    const hasDom = list && list.children && list.children.length > 0;
    const typing = !!document.querySelector('.typing, [data-typing="true"]');
    if (askConfirm && (hasDom || typing)) {
      if (!confirm('Xoá cuộc hội thoại hiện tại và bắt đầu cuộc mới?')) return;
    }

    // 3) Xoá vùng hiển thị tin nhắn
    try { list.innerHTML = ''; } catch(e){}

    // 4) Xoá lịch sử lưu local (tuỳ app bạn có dùng hay không)
    try {
      localStorage.removeItem('pbpl_history');
      sessionStorage.removeItem('pbpl_history');
    } catch(e){}

    // 5) Xoá mảng chat trong bộ nhớ (nếu app của bạn có đặt)
    try { if (window.chathistory) window.chathistory = []; } catch(e){}

    // 6) Đưa con trỏ về ô nhập
    try { if (ta) { ta.value = ''; ta.focus(); } } catch(e){}
  }

  /* ====== Gán sự kiện ====== */
  if (btn) btn.addEventListener('click', () => resetChat({ askConfirm: true }));

  // Hotkey Ctrl/Cmd + Shift + K
  window.addEventListener('keydown', (ev) => {
    const isMac = navigator.platform.toUpperCase().includes('MAC');
    const cmdOK = isMac ? ev.metaKey : ev.ctrlKey;
    if (cmdOK && ev.shiftKey && (ev.key === 'K' || ev.key === 'k')) {
      ev.preventDefault();
      resetChat({ askConfirm: true });
    }
  });

  // Tự focus ô nhập khi trang sẵn sàng lần đầu
  if (ta) { setTimeout(()=> ta.focus(), 50); }

  // === Tuỳ chọn: nếu KHÔNG muốn hỏi confirm khi xoá, đổi event ở trên thành:
  // if (btn) btn.addEventListener('click', () => resetChat({ askConfirm: false }));
})();
</script>
<!-- /PBPL :: New Chat -->
  <!-- PBPL :: New Chat (compact patch) -->
<!-- Nút New Chat -->
<button id="pbpl-new"
  class="pbpl-new"
  title="New chat (Ctrl/Cmd + Shift + K)"
  aria-label="New chat">
  <!-- Icon plus mảnh, màu xám -->
  <svg viewBox="0 0 24 24" width="20" height="20" fill="none"
    stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
    <path d="M12 5v14M5 12h14"/>
  </svg>
</button>

<!-- Style nút -->
<style>
  .pbpl-new{
    position:fixed; bottom:16px; right:16px; z-index:1000;
    width:36px; height:36px; border:1px solid #e5e7eb; border-radius:12px;
    background:#fff; color:#a0a0a0; /* xám nhẹ */
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; transition:background .18s, color .18s, box-shadow .18s, transform .12s;
    box-shadow: 1px 2px 4px rgba(0,0,0,0.06);
  }
  .pbpl-new:hover{ background:#f8f8f8; color:#111827; box-shadow: 2px 3px 6px rgba(0,0,0,0.08); }
  .pbpl-new:active{ transform:translateY(.5px); }
</style>

<!-- Logic nút -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const btn = document.getElementById('pbpl-new');
    if (!btn) return;
    const resetChat = () => {
      try { window.abortController?.abort(); } catch(e){}
      const list = document.querySelector('.msgs') || document.getElementById('messages');
      if (list) list.innerHTML = '';
      localStorage.removeItem('pbpl_history');
      sessionStorage.removeItem('pbpl_history');
      if (window.chatHistory) window.chatHistory = [];
      const ta = document.querySelector('textarea');
      if (ta) { ta.value = ''; ta.focus(); }
      if (list && list.classList.contains('msgs')) {
        const note = document.createElement('div');
        note.className = 'msg ai typing';
        note.textContent = 'Bắt đầu cuộc hội thoại mới.';
        list.appendChild(note);
        list.scrollTop = list.scrollHeight;
        setTimeout(() => note.remove(), 1200);
      }
    };
    btn.addEventListener('click', resetChat);
    // Phím tắt Ctrl/Cmd + Shift + K
    document.addEventListener('keydown', (ev) => {
      if ((ev.ctrlKey || ev.metaKey) && ev.shiftKey && ev.key.toLowerCase() === 'k') {
        ev.preventDefault();
        resetChat();
      }
    });
  });
</script>
<!-- /PBPL :: New Chat -->
</body>
</html>
