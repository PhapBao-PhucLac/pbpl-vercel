<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhÃ¡p Báº£o PhÃºc Láº¡c Chatbot</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@700;900&display=swap" rel="stylesheet">
<!-- Favicon & app icons -->
<link rel="icon" href="./logo.svg" type="image/svg+xml">
<link rel="alternate icon" href="./logo.png" type="image/png">
<link rel="icon" href="./logo.png" sizes="32x32" type="image/png">
<link rel="icon" href="./logo.png" sizes="192x192" type="image/png">
<link rel="apple-touch-icon" href="./logo.png" sizes="180x180">
<link rel="mask-icon" href="./logo.svg" color="#16a085"><!-- Safari pinned tab -->
<meta name="theme-color" content="#16a085"><!-- mÃ u thanh Ä‘á»‹a chá»‰ trÃªn Android -->
  <style>
    :root{
      --ink:#121212; --muted:#f4f4f5; --line:#e9e9ee;
      --brand:#16a085; --accent:#a855f7; --soft:#fafafa;
    }
    html,body{height:100%;}
    body{
      margin:0; font:16px/1.65 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% -10%, #f8f5ff 0, transparent 50%),
        radial-gradient(1000px 400px at 120% 20%, #e8fff6 0, transparent 45%), #fff;
    }
    .wrap{max-width:1024px; margin:28px auto 40px; padding:0 16px;}
    /* Header */
    <picture>
  <source srcset="./logo.svg" type="image/svg+xml">
  <img src="./logo.png" alt="PhÃ¡p Báº£o PhÃºc Láº¡c" class="brand-logo">
</picture>
<h1>PHÃP Báº¢O PHÃšC Láº C â€“ CHATBOT</h1>
<div class="mantra">â€œTá»« hÃ²a â€“ ChÃ¡nh kiáº¿n â€“ Lá»£i láº¡câ€</div>
<div class="sub">Nam mÃ´ Bá»•n SÆ° ThÃ­ch Ca MÃ¢u Ni Pháº­t Â· â€œHiá»ƒu sÃ¢u ChÃ¡nh PhÃ¡p â€“ HÆ°á»›ng Ä‘áº¡o tu táº­pâ€</div>

    /* Chips */
    .chips{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:14px 0 20px;}
    .chip{padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:999px;cursor:pointer;font-size:14px;}
    .chip.active{background:#f0fff7;border-color:#ccefe3;box-shadow:0 0 0 2px #e6faf4 inset;}

    /* Chat card */
    .card{border:1px solid var(--line);border-radius:18px;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.04);}
    #messages{max-height:64vh;min-height:320px;overflow:auto;padding:18px;contain:content;}
    .bubble{padding:12px 14px;margin:10px 0;border-radius:16px;}
    .bubble.user{background:var(--muted);color:var(--ink);margin-left:auto;width:fit-content;max-width:82%;}
    .bubble.assistant{background:#fff;border:1px solid var(--line);max-width:82%;}
    .bubble.note{font-size:12px;opacity:.75;text-align:center;background:transparent;border:none;}

    /* Toolbar trong card */
    .toolbar{display:flex;gap:8px;justify-content:flex-end;margin:8px 12px 0;}
    .tb-btn{font:13px/1 system-ui;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;}
    .tb-btn.primary{background:var(--brand);color:#fff;border-color:transparent;}
    .tb-btn:disabled{opacity:.6;cursor:not-allowed;}

    /* Composer */
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--line);background:#fff;border-radius:0 0 18px 18px;}
    #chat-input{flex:1;padding:12px 14px;border:2px solid #ddd;border-radius:12px;outline:none;}
    #chat-input:focus{border-color:#c7ece4;box-shadow:0 0 0 3px #eaf8f4;}
    #send-btn{padding:12px 18px;border-radius:12px;border:0;background:var(--brand);color:#fff;cursor:pointer;font-weight:700;}
    #send-btn:disabled{opacity:.6;cursor:not-allowed;}
    .hint{font-size:12px;color:#666;margin:10px 2px;}

    /* Markdown Ä‘áº¹p */
    .assistant h1,.assistant h2,.assistant h3{margin:6px 0 8px;}
    .assistant p,.assistant ul,.assistant ol{margin:8px 0;}
    .assistant ul,.assistant ol{padding-left:22px;}
    .assistant code{background:#f6f6f6;padding:2px 6px;border-radius:6px;}
    .assistant a{color:#0ea5e9;text-decoration:none;} .assistant a:hover{text-decoration:underline;}

    /* FOOT MENU (menu phá»¥) */
    .footbar{
      margin-top:14px;background:var(--soft);border:1px solid var(--line);border-radius:12px;
      display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;
    }
    .fb-left{display:flex;align-items:center;gap:10px;}
    .fb-right{display:flex;align-items:center;gap:8px;}
    .mini-btn,.mini-icon{
      padding:8px 12px;border-radius:10px;border:1px solid var(--line);background:#fff;cursor:pointer;font:13px/1 system-ui;
    }
    .mini-icon{width:38px;height:38px;display:inline-grid;place-items:center;}
    .mini-icon.primary{background:var(--brand);color:#fff;border-color:transparent;}
    .tip{font-size:12px;color:#666;}
    .kbd{display:inline-block;border:1px solid #ddd;border-bottom-width:2px;border-radius:6px;padding:2px 6px;background:#fff;margin:0 2px;font-size:12px;}
    @media (max-width:720px){ .tip{display:none;} .hero h1{font-size:24px;} #messages{max-height:58vh;} }
  </style>

  <!-- Markdown + XSS sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="hero">
      <!-- Logo: Æ°u tiÃªn SVG, fallback PNG -->
<picture>
  <source srcset="./logo.svg" type="image/svg+xml" />
  <img src="./logo.png" alt="PhÃ¡p Báº£o PhÃºc Láº¡c" class="brand-logo" />
</picture>
        <path d="M12 3c1.8 2.7 2.6 5.1 2.4 7.2 1.7-.7 3.3-2 4.6-4-0.1 3-1.2 5.2-3 6.7 2 .1 4-.5 6-2-1.1 3.8-3.6 6-7.5 6.7.7.6 1.5 1.3 2.3 2.3-2.5-.2-4.3-1-5.2-2-0.9 1-2.7 1.8-5.2 2 .8-1 1.6-1.7 2.3-2.3-3.9-.7-6.4-2.9-7.5-6.7 2 .9 4 1.1 6 2-1.8-1.5-2.9-3.7-3-6.7 1.3 2 2.9 3.3 4.6 4C9.4 8.1 10.2 5.7 12 3z" fill="#a855f7"/>
      </svg>
      <h1>PHÃP Báº¢O PHÃšC Láº C â€“ CHATBOT</h1>
      <div class="mantra">â€œTá»« hÃ²a â€“ ChÃ¡nh kiáº¿n â€“ Lá»£i láº¡câ€</div>
      <div class="sub">Nam mÃ´ Bá»•n SÆ° ThÃ­ch Ca MÃ¢u Ni Pháº­t Â· â€œHiá»ƒu sÃ¢u ChÃ¡nh PhÃ¡p â€“ HÆ°á»›ng Ä‘áº¡o tu táº­pâ€</div>
    </div>

    <!-- Lá»i chÃ o + chips -->
    <div class="card" style="padding:18px;margin-bottom:10px;text-align:center;">
      <div style="font-weight:600;">Xin chÃ o báº¡n! Báº¡n Ä‘ang muá»‘n tÃ¬m hiá»ƒu Ä‘iá»u gÃ¬ trong Pháº­t phÃ¡p?</div>
      <div class="chips" id="chips">
        <button class="chip" data-topic="GiÃ¡o lÃ½">ğŸª· GiÃ¡o lÃ½</button>
        <button class="chip" data-topic="Kinh vÄƒn">ğŸ“œ Kinh vÄƒn</button>
        <button class="chip" data-topic="SÃ¡ch nÃ³i Pháº­t giÃ¡o">ğŸ§ SÃ¡ch nÃ³i Pháº­t giÃ¡o</button>
        <button class="chip" data-topic="Váº¥n Ä‘Ã¡p">ğŸ’¬ Váº¥n Ä‘Ã¡p</button>
        <button class="chip" data-topic="Lá»™ trÃ¬nh tu há»c">ğŸ›¤ï¸ Lá»™ trÃ¬nh</button>
        <button class="chip" data-topic="TÃ¬m phÃ¡p thoáº¡i">ğŸ” TÃ¬m phÃ¡p thoáº¡i</button>
      </div>
    </div>

    <!-- Chat -->
    <form id="chat-form" class="card" autocomplete="off">
      <div id="messages" aria-live="polite"></div>

      <div class="toolbar">
        <button id="clear-btn" class="tb-btn" title="XÃ³a toÃ n bá»™ há»™i thoáº¡i">XÃ³a</button>
        <button id="regen-btn" class="tb-btn" title="Há»i láº¡i vá»›i cÃ¹ng cÃ¢u há»i">LÃ m má»›i</button>
        <button id="stop-btn" class="tb-btn" style="display:none" title="Dá»«ng phÃ¡t">Dá»«ng</button>
      </div>

      <div class="composer">
        <input id="chat-input" name="message" placeholder="Nam mÃ´ Bá»•n SÆ° ThÃ­ch Ca MÃ¢u Ni Pháº­t ğŸ™ Báº¡n muá»‘n há»i Ä‘iá»u gÃ¬?" />
        <button id="send-btn" type="submit">Gá»­i</button>
      </div>
    </form>

    <!-- FOOT MENU (menu phá»¥ nhÆ° mock) -->
    <div class="footbar">
      <div class="fb-left">
        <button id="newchat-btn" class="mini-btn">ï¼‹ New Chat</button>
        <span class="tip">
          Báº¥m <span class="kbd">Ctrl/Cmd</span> + <span class="kbd">Shift</span> + <span class="kbd">K</span> Ä‘á»ƒ báº¯t Ä‘áº§u cuá»™c há»™i thoáº¡i má»›i.
        </span>
      </div>
      <div class="fb-right">
        <button id="stepback-btn" class="mini-icon" title="LÃ¹i má»™t bÆ°á»›c" aria-label="LÃ¹i má»™t bÆ°á»›c">â®Œ</button>
        <button id="copy-btn" class="mini-icon" title="Sao chÃ©p há»™i thoáº¡i" aria-label="Sao chÃ©p">ğŸ“‹</button>
        <button id="save-btn" class="mini-icon" title="LÆ°u (.md)" aria-label="LÆ°u">ğŸ’¾</button>
        <button id="print-btn" class="mini-icon primary" title="In ra PDF" aria-label="In/PDF">â¤´</button>
      </div>
    </div>

    <div class="hint">Máº¹o: <b>Enter</b> Ä‘á»ƒ gá»­i, <b>Shift+Enter</b> Ä‘á»ƒ xuá»‘ng dÃ²ng. Náº¿u trang cháº­m sau vÃ i ngÃ y dÃ¹ng, há»‡ thá»‘ng sáº½ tá»± rÃºt gá»n lá»‹ch sá»­ hiá»ƒn thá»‹ Ä‘á»ƒ nháº¹ mÃ¡y.</div>
  </div>

  <!-- Markdown + XSS sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>

  <script>
  // ===================== Cáº¤U HÃŒNH =====================
  const API_URL        = '/api/chat';         // fallback JSON
  const API_URL_STREAM = '/api/chat-stream';  // SSE streaming
  const MAX_NODES = 120, TRIM_BATCH = 20;

  // ===================== THAM CHIáº¾U UI =====================
  const form   = document.getElementById('chat-form');
  const pane   = document.getElementById('messages');
  const input  = document.getElementById('chat-input');
  const send   = document.getElementById('send-btn');
  const stopBtn  = document.getElementById('stop-btn');
  const regenBtn = document.getElementById('regen-btn');
  const clearBtn = document.getElementById('clear-btn');

  // Foot menu
  const newChatBtn  = document.getElementById('newchat-btn');
  const stepBackBtn = document.getElementById('stepback-btn');
  const copyBtn     = document.getElementById('copy-btn');
  const saveBtn     = document.getElementById('save-btn');
  const printBtn    = document.getElementById('print-btn');

  // Chips
  const chipsBox = document.getElementById('chips');
  let activeTopic = '';

  chipsBox.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip'); if(!btn) return;
    chipsBox.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    if(activeTopic === btn.dataset.topic){ activeTopic=''; }
    else{ activeTopic = btn.dataset.topic; btn.classList.add('active'); }
  });

  // ===================== TIá»†N ÃCH =====================
  function appendBubble(text, who='assistant'){
    const el = document.createElement('div');
    el.className = 'bubble ' + (who==='user' ? 'user' : 'assistant');
    el.textContent = text ?? '';
    // lÆ°u láº¡i báº£n Markdown thÃ´ Ä‘á»ƒ xuáº¥t file
    el.dataset.md = text || '';
    pane.appendChild(el);

    if (pane.children.length > MAX_NODES) {
      for (let i=0;i<TRIM_BATCH;i++) if (pane.firstChild) pane.removeChild(pane.firstChild);
      if (!pane.dataset.truncated) {
        const note = document.createElement('div');
        note.className = 'bubble note';
        note.textContent = 'ÄÃ£ rÃºt gá»n lá»‹ch sá»­ hiá»ƒn thá»‹ Ä‘á»ƒ trang mÆ°á»£t hÆ¡n.';
        pane.insertBefore(note, pane.firstChild);
        pane.dataset.truncated = '1';
      }
    }
    pane.scrollTop = pane.scrollHeight;
    return el;
  }

  function finalizeAsMarkdown(bubbleEl, text){
    const html = DOMPurify.sanitize(marked.parse(text || ''));
    bubbleEl.innerHTML = html;
    bubbleEl.dataset.md = text || '';
    bubbleEl.classList.add('assistant');
  }

  function setBusy(b){
    send.disabled = b; input.readOnly = b;
    if (b){ send.dataset._t = send.textContent; send.textContent = 'Äang gá»­iâ€¦'; stopBtn.style.display='inline-block'; }
    else  { send.textContent = send.dataset._t || 'Gá»­i'; stopBtn.style.display='none'; }
  }

  // Export helpers
  function bubblesToMarkdown(){
    const out = [];
    pane.querySelectorAll('.bubble').forEach(el=>{
      const role = el.classList.contains('user') ? 'NgÆ°á»i há»i' : 'Trá»£ lÃ½';
      const md   = (el.dataset.md || el.textContent || '').trim();
      out.push(`**${role}:**\n\n${md}\n`);
    });
    return out.join('\n').trim() + '\n';
  }
  function saveFile(filename, content, mime='text/plain'){
    const blob = new Blob([content], {type:mime});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 100);
  }
  function ymdhs(){
    const d=new Date();
    const p=n=>String(n).padStart(2,'0');
    return `${d.getFullYear()}${p(d.getMonth()+1)}${p(d.getDate())}_${p(d.getHours())}${p(d.getMinutes())}`;
  }

  // ===================== STREAM =====================
  let currentController = null;
  async function streamAPI(message, history, onToken, onDone){
    currentController = new AbortController();
    const res = await fetch(API_URL_STREAM, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message, history }), signal: currentController.signal
    });
    const ct = res.headers.get('content-type') || '';
    if(!res.ok){
      const t = ct.includes('application/json') ? JSON.stringify(await res.json(), null, 2) : await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
    }
    if(!ct.includes('text/event-stream')){
      const reply = await callAPI(message, history);
      onToken && onToken(reply, reply); onDone && onDone(reply); return;
    }
    const reader = res.body.getReader(); const decoder = new TextDecoder('utf-8');
    let buffer='', acc='';
    try{
      while(true){
        const {value, done} = await reader.read();
        if(done) break;
        buffer += decoder.decode(value, {stream:true});
        const events = buffer.split('\n\n'); buffer = events.pop() || '';
        for(const evt of events){
          const lines = evt.split('\n').filter(Boolean);
          for(const line of lines){
            if(!line.startsWith('data:')) continue;
            const data = line.slice(5).trim();
            if(data==='[DONE]'){ onDone && onDone(acc); return; }
            try{ const j=JSON.parse(data);
              const token=j?.choices?.[0]?.delta?.content||'';
              if(token){ acc+=token; onToken && onToken(acc, token); }
            }catch{}
          }
        }
      }
      onDone && onDone(acc);
    }finally{ currentController=null; }
  }
  function stopStream(){ if(currentController){ currentController.abort(); currentController=null; } }

  // ===================== Fallback JSON =====================
  async function callAPI(message, history){
    const res = await fetch(API_URL, { method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ message, history }) });
    const ct = res.headers.get('content-type') || '';
    if(!res.ok){
      const t = ct.includes('application/json')? JSON.stringify(await res.json(), null, 2) : await res.text();
      throw new Error(`HTTP ${res.status} ${res.statusText}\n${t}`);
    }
    if(ct.includes('application/json')){
      const data = await res.json();
      return data?.reply || data?.choices?.[0]?.message?.content || JSON.stringify(data, null, 2);
    }
    return await res.text();
  }

  // ===================== Gá»¬I TIN =====================
  let lastUserMsg = '';
  form.addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    try{
      const msg = (input.value || '').trim(); if(!msg) return;
      lastUserMsg = msg;

      const msgWithTopic = activeTopic ? `[Chá»§ Ä‘á» Æ°u tiÃªn: ${activeTopic}] ${msg}` : msg;

      appendBubble(msg, 'user');
      input.value=''; setBusy(true);

      const history = Array.from(pane.querySelectorAll('.bubble'))
        .slice(-50)
        .map(el => ({ role: el.classList.contains('user') ? 'user' : 'assistant', content: el.dataset.md || el.textContent || '' }));

      const botBubble = appendBubble('', 'assistant');

      await streamAPI(msgWithTopic, history,
        acc => { botBubble.textContent = acc; botBubble.dataset.md = acc; pane.scrollTop = pane.scrollHeight; },
        full => { finalizeAsMarkdown(botBubble, full); });

    }catch(err){
      console.error('[Chat][Submit]', err);
      appendBubble('Lá»—i: ' + (err?.message || err), 'assistant');
    }finally{
      setBusy(false); input.focus();
    }
  });

  // Enter gá»­i, Shift+Enter xuá»‘ng dÃ²ng
  input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); form.requestSubmit(); }
  });

  // ====== FOOT MENU actions ======
  function newChat(){
  pane.innerHTML='';
  if (ENABLE_GREETING_BUBBLE) greet();
  lastUserMsg='';
}
  function stepBack(){
    // XÃ³a cáº·p (assistant + user) cuá»‘i cÃ¹ng náº¿u cÃ³
    const items = Array.from(pane.querySelectorAll('.bubble'));
    if(items.length===0) return;
    // Náº¿u pháº§n tá»­ cuá»‘i lÃ  assistant => xÃ³a nÃ³; náº¿u trÆ°á»›c Ä‘Ã³ lÃ  user => xÃ³a luÃ´n.
    let last = items.pop(); last.remove();
    if(items.length){
      let prev = items.pop();
      if(prev && prev.classList.contains('user')) prev.remove();
    }
  }
  async function copyTranscript(){
    const md = bubblesToMarkdown();
    await navigator.clipboard.writeText(md).catch(()=>{});
  }
  function saveMarkdown(){ saveFile(`PBPL_Chat_${ymdhs()}.md`, bubblesToMarkdown(), 'text/markdown'); }
  function printPDF(){
    const html = `
<!doctype html><html><head><meta charset="utf-8">
<title>PBPL Chat ${ymdhs()}</title>
<style>
  body{font:15px/1.6 system-ui,Segoe UI,Roboto,Helvetica,Arial;padding:24px;color:#111;}
  h1{font-size:20px;margin:0 0 12px;}
  .msg{margin:10px 0;padding:10px 12px;border-radius:10px;border:1px solid #eee;}
  .who{font-weight:700;margin-bottom:6px;}
</style></head><body>
<h1>PhÃ¡p Báº£o PhÃºc Láº¡c â€“ Chatbot</h1>
${Array.from(pane.querySelectorAll('.bubble')).map(el=>{
  const who = el.classList.contains('user')?'NgÆ°á»i há»i':'Trá»£ lÃ½';
  const md  = (el.dataset.md || el.textContent || '').replace(/</g,'&lt;');
  return `<div class="msg"><div class="who">${who}</div><div>${md.replace(/\n/g,'<br>')}</div></div>`;
}).join('')}
</body></html>`;
    const w = window.open('', '_blank'); if(!w) return;
    w.document.open(); w.document.write(html); w.document.close();
    w.focus(); w.print();
  }

  newChatBtn.addEventListener('click', newChat);
  stepBackBtn.addEventListener('click', stepBack);
  copyBtn.addEventListener('click', copyTranscript);
  saveBtn.addEventListener('click', saveMarkdown);
  printBtn.addEventListener('click', printPDF);

  // Toolbar trong card
  stopBtn.addEventListener('click', ()=> stopStream());
  regenBtn.addEventListener('click', ()=>{ if(!lastUserMsg) return; input.value=lastUserMsg; form.requestSubmit(); });
  clearBtn.addEventListener('click', newChat);

  // PhÃ­m táº¯t: New chat (Ctrl/Cmd + Shift + K), Save (Ctrl/Cmd + S)
  window.addEventListener('keydown', (e)=>{
    const mod = e.ctrlKey || e.metaKey;
    if(mod && e.shiftKey && e.key.toLowerCase()==='k'){ e.preventDefault(); newChat(); }
    if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); saveMarkdown(); }
  });

  function greet(){
  // náº¿u muá»‘n báº­t láº¡i bong bÃ³ng chÃ o, Ä‘á»•i giÃ¡ trá»‹ cÃ´ng táº¯c á»Ÿ trÃªn thÃ nh true
  if (ENABLE_GREETING_BUBBLE) {
    appendBubble('Nam mÃ´ Bá»•n SÆ° ThÃ­ch Ca MÃ¢u Ni Pháº­t! Báº¡n Ä‘ang muá»‘n tÃ¬m hiá»ƒu Ä‘iá»u gÃ¬ trong Pháº­t phÃ¡p?');
  }
}
// khÃ´ng gá»i greet() khi false
if (ENABLE_GREETING_BUBBLE) greet();

  console.log('[Chat] Ready âœ…');
  </script>
</body>
</html>
