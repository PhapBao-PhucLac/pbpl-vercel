<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</title>
  <meta name="description" content="Ph√°p B·∫£o Ph√∫c L·∫°c Chatbot ‚Äî H·ªèi ƒë√°p Ph·∫≠t ph√°p" />
  <style>
    :root{
      --bg:#faf9f7; --card:#ffffff; --ink:#3b0f14; --muted:#6e4b50;
      --brand:#7a1f2a; --ring: rgba(122,31,42,.18);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
         background:var(--bg);color:var(--ink);display:flex;align-items:center;justify-content:center}
    .app{width:100%;max-width:920px;height:100dvh;padding:12px;display:flex;flex-direction:column;gap:12px}
    .header{display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:16px;
            box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .logo{width:48px;height:48px;border-radius:12px;display:grid;place-items:center;background:#fff;border:1px solid #efe3e5;}
    .title h1{margin:0;font-size:18px;color:#7a1f2a}
    .title p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .chat{flex:1;background:var(--card);border-radius:16px;padding:12px;display:flex;flex-direction:column;gap:12px;
          box-shadow:0 4px 20px rgba(0,0,0,.06)}
    .greeting{font-size:14px;color:#7a1f2a;background:#fff3f5;border:1px solid #f0d7dc;padding:10px 12px;border-radius:12px}
    .messages{flex:1;overflow:auto;display:flex;flex-direction:column;gap:10px;padding-right:4px}
    .msg{display:flex;gap:10px;align-items:flex-start}
    .msg .bubble{max-width:80%;padding:10px 12px;border-radius:14px;line-height:1.45;font-size:14px;
                 box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .msg.assistant .bubble{background:#f1f5f9}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:#fff3f5;border:1px solid #f0d7dc}
    .composer{display:flex;gap:10px;align-items:flex-end}
    .box{flex:1;position:relative}
    textarea{width:100%;min-height:48px;max-height:220px;resize:vertical;padding:12px 44px 12px 12px;border-radius:14px;
             border:1px solid #e5e7eb;outline:none;background:#fff;font-size:14px;line-height:1.35;
             box-shadow:0 2px 10px rgba(0,0,0,.04)}
    textarea:focus{border-color:var(--brand);box-shadow:0 0 0 4px var(--ring)}
    .send{border:none;background:var(--brand);color:#fff;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer}
    .send:disabled{opacity:.6;cursor:not-allowed}
    .right-icons{position:absolute;right:6px;bottom:6px;display:flex;gap:6px}
    .pill{font-size:10px;color:#7a1f2a;background:#f6e6e9;border:1px solid #e6c5cb;padding:4px 6px;border-radius:999px}
    .footer{display:flex;justify-content:space-between;gap:12px;color:var(--muted);font-size:12px}
    .link{color:#7a1f2a;text-decoration:none}
    .spinner{width:16px;height:16px;border:2px solid #e2e8f0;border-top-color:#7a1f2a;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media (max-width:640px){.msg .bubble{max-width:90%}.header{border-radius:12px}.chat{border-radius:12px}}
  </style>
</head>
<body>
  <main class="app" id="app">
    <header class="header">
      <div class="logo" aria-hidden="true">
        <img src="logo.png" alt="Ph√°p B·∫£o Ph√∫c L·∫°c" style="max-width:42px;height:auto;display:block" />
      </div>
      <div class="title">
        <h1>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</h1>
        <p>Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t ‚Äî H·ªèi ƒëi·ªÅu b·∫°n mu·ªën h·ªçc h√¥m nay.</p>
      </div>
    </header>

    <section class="chat" role="region" aria-label="Khu v·ª±c h·ªôi tho·∫°i">
      <div class="greeting">üôè Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t. B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?</div>
      <div class="messages" id="messages" aria-live="polite" aria-busy="false"></div>

      <form class="composer" id="composer" autocomplete="off">
        <div class="box">
          <label class="sr-only" for="input">Nh·∫≠p c√¢u h·ªèi...</label>
          <textarea id="input" placeholder="G√µ c√¢u h·ªèi c·ªßa b·∫°n‚Ä¶ (Shift+Enter xu·ªëng d√≤ng)" rows="2"></textarea>
          <div class="right-icons"><span class="pill" title="L∆∞u h·ªôi tho·∫°i tr√™n thi·∫øt b·ªã">T·ª± l∆∞u</span></div>
        </div>
        <button class="send" id="send" type="submit">G·ª≠i</button>
      </form>

      <div class="footer">
        <div><span id="status">S·∫µn s√†ng.</span></div>
        <div><a class="link" href="#" id="clear">X√≥a h·ªôi tho·∫°i</a></div>
      </div>
    </section>
  </main>

  <script>
    const CONFIG = {
      SERVER_URL: '/api/chat',
      SYSTEM_PROMPT: `B·∫°n l√† Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äî tr·ª£ l√Ω Ph·∫≠t h·ªçc t·ª´ bi, khi√™m cung, tr·∫£ l·ªùi r√µ r√†ng, ng·∫Øn g·ªçn, c√≥ tr√≠ch d·∫´n khi ph√π h·ª£p; gi·ªØ ch√°nh ki·∫øn.`
    };
    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const formEl = document.getElementById('composer');
    const sendBtn = document.getElementById('send');
    const statusEl = document.getElementById('status');
    const clearBtn = document.getElementById('clear');
    const STORAGE_KEY = 'pbpl_chat_v1';
    let chat = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    if (!chat.length) chat = [{ role:'system', content: CONFIG.SYSTEM_PROMPT }];

    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(chat)); }
    function toHTML(t){ const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      t = esc(t); t=t.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\n/g,'<br/>');
      t=t.replace(/(https?:\/\/[^\s]+)/g,'<a class="link" target="_blank" rel="noopener">$1</a>'); return t; }
    function render(){ messagesEl.innerHTML=''; for(const m of chat){ if(m.role==='system') continue;
      const row=document.createElement('div'); row.className='msg '+(m.role==='assistant'?'assistant':'user');
      const bubble=document.createElement('div'); bubble.className='bubble'; bubble.innerHTML=toHTML(m.content);
      row.appendChild(bubble); messagesEl.appendChild(row);} messagesEl.scrollTop=messagesEl.scrollHeight; }
    render();

    clearBtn.addEventListener('click', e=>{ e.preventDefault(); if(confirm('X√≥a to√†n b·ªô h·ªôi tho·∫°i?')){ chat=[{role:'system',content:CONFIG.SYSTEM_PROMPT}]; save(); render(); }});
    inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); formEl.dispatchEvent(new Event('submit')); }});

    formEl.addEventListener('submit', async (e)=>{
      e.preventDefault(); const text = inputEl.value.trim(); if(!text) return; inputEl.value='';
      chat.push({ role:'user', content:text }); save(); render(); setBusy(true);
      try{
        const res = await fetch(CONFIG.SERVER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ messages: chat }) });
        if(!res.ok) throw new Error('Bad response: '+res.status);
        const data = await res.json();

        // hi·ªáu ·ª©ng ch·ªØ ch·∫°y (pseudo-streaming)
        const full = data.reply || '';
        let acc = '';
        chat.push({ role:'assistant', content: '' }); save(); render();
        for (let i=0;i<full.length;i++){
          acc += full[i];
          chat[chat.length-1].content = acc;
          if (i % 3 === 0) { save(); render(); await new Promise(r=>setTimeout(r, 8)); }
        }
      }catch(err){ chat.push({ role:'assistant', content:'Xin l·ªói, h·ªá th·ªëng ƒëang b·∫≠n ho·∫∑c API ch∆∞a s·∫µn s√†ng.' }); }
      finally{ setBusy(false); save(); render(); }
    });

    function setBusy(b){ messagesEl.setAttribute('aria-busy', b?'true':'false'); statusEl.innerHTML = b? '<span class="spinner"></span> ƒêang tr·∫£ l·ªùi‚Ä¶':'S·∫µn s√†ng.'; sendBtn.disabled=b; }
  </script>
</body>
</html>
