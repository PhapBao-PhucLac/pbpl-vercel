<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</title>

<!-- Favicon & meta image (tu·ª≥ b·∫°n thay b·∫±ng ·∫£nh ri√™ng) -->
<link rel="icon" href="/logo.png">
<meta property="og:title" content="Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot" />
<meta property="og:description" content="Hi·ªÉu s√¢u Ch√°nh Ph√°p ‚Äì H∆∞·ªõng ƒë·∫°o tu t·∫≠p." />
<meta property="og:image" content="https://pbpl-vercel.vercel.app/logo.png" />
<meta name="theme-color" content="#0f172a" />

<style>
  :root{
    --bg:#f6f7f9;
    --panel:#ffffff;
    --ink:#0f172a;
    --muted:#6b7280;
    --brand:#111827;
    --ring:#d1d5db;
    --pill:#111827;
    --bubble:#eef2ff;
    --user:#ecfeff;
    --radius:16px;
    --maxw:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  /* N·ªÅn sen nh·∫π (SVG pattern m·ªù) */
  body::before{
    content:"";
    position:fixed; inset:0;
    background:
      radial-gradient(ellipse at top left, #0000 60%, rgba(0,0,0,.03)) ,
      url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="600" height="600" viewBox="0 0 600 600" fill="none">\
      <g stroke="%23bdbdbd" stroke-width="1" opacity=".18">\
      <path d="M300 80c50 80 50 160 0 240c-50-80-50-160 0-240z"/>\
      <path d="M300 120c85 45 130 110 130 190c-85-45-175-45-260 0c0-80 45-145 130-190z"/>\
      <circle cx="300" cy="330" r="140" fill="none"/>\
      </g></svg>') center/700px 700px repeat;
    pointer-events:none;
  }

  .wrap{max-width:var(--maxw);margin:24px auto;padding:0 16px}

  /* Header */
  .hero{
    background:var(--panel);
    border-radius:var(--radius);
    box-shadow:0 6px 18px rgba(2,6,23,.08);
    padding:20px 24px;display:flex;gap:16px;align-items:center;
  }
  .hero img{width:64px;height:64px;border-radius:999px;flex:0 0 auto;box-shadow:0 0 0 2px #fff, 0 0 0 3px #eee}
  .hero h1{margin:0;font-weight:700;font-size:22px;letter-spacing:.2px}
  .hero small{display:block;color:var(--muted)}
  .hero em{font-style:normal;color:#374151}
  .greet{
    margin-top:16px;background:var(--panel);border-radius:var(--radius);
    padding:14px 16px;color:#374151;border:1px solid var(--ring)
  }

  /* Quick menu */
  .menu{
    display:flex;flex-wrap:wrap;gap:10px;margin:16px 0 0;
  }
  .chip{
    border:1px solid var(--ring);
    background:#fff;border-radius:999px;padding:8px 14px;cursor:pointer;
    color:#111827;font-weight:600;transition:.15s;
  }
  .chip:hover{transform:translateY(-1px);box-shadow:0 8px 20px rgba(2,6,23,.08)}

  /* Chat panel */
  .panel{
    margin-top:16px;background:var(--panel);border-radius:var(--radius);
    box-shadow:0 6px 18px rgba(2,6,23,.06);padding:18px;border:1px solid var(--ring);
  }
  .msgs{min-height:320px;max-height:60vh;overflow:auto;display:flex;flex-direction:column;gap:12px;padding:8px}
  .msg{max-width:760px;padding:12px 14px;border-radius:14px;white-space:pre-wrap}
  .me{align-self:flex-end;background:var(--user);border:1px solid #bae6fd}
  .ai{align-self:flex-start;background:var(--bubble);border:1px solid #c7d2fe}
  .typing{opacity:.6;font-style:italic}

  /* Composer */
  .composer{display:flex;gap:10px;align-items:flex-end;margin-top:12px}
  textarea{
    flex:1;border:1px solid var(--ring);border-radius:14px;padding:14px 14px 16px 14px;min-height:60px;
    outline:none;resize:vertical;background:#fff;color:var(--ink);
  }
  .btn{
    border:none;background:var(--pill);color:#fff;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer
  }
  .btn:disabled{opacity:.5;cursor:not-allowed}

  /* Footer actions */
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .ghost{background:#fff;color:#111;border:1px solid var(--ring)}
  .muted{color:var(--muted);font-size:13px;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <!-- HEADER -->
    <div class="hero">
      <img src="/logo.png" alt="Logo PBPL">
      <div>
        <h1>Ph√°p B·∫£o Ph√∫c L·∫°c ‚Ä¢ Chatbot</h1>
        <small>NAM M√î B·ªîN S∆Ø TH√çCH CA M√ÇU NI PH·∫¨T ‚Äî <em>‚ÄúHi·ªÉu s√¢u Ch√°nh Ph√°p ‚Äì H∆∞·ªõng ƒë·∫°o tu t·∫≠p‚Äù</em></small>
      </div>
    </div>

    <!-- GREETING -->
    <div class="greet">Nam m√¥ B·ªïn S∆∞ Th√≠ch Ca M√¢u Ni Ph·∫≠t. B·∫°n ƒëang mu·ªën t√¨m hi·ªÉu ƒëi·ªÅu g√¨ trong Ph·∫≠t ph√°p?</div>

    <!-- QUICK MENU -->
    <div class="menu" id="quickMenu">
      <button class="chip" data-text="Gi·∫£i th√≠ch gi√∫p t√¥i gi√°o l√Ω 'T·ª© Di·ªáu ƒê·∫ø' th·∫≠t d·ªÖ hi·ªÉu.">Gi√°o l√Ω</button>
      <button class="chip" data-text="H√£y t√≥m l∆∞·ª£c v√† tr√≠ch d·∫´n m·ªôt ƒëo·∫°n kinh ph√π h·ª£p v·ªõi ƒë·ªùi s·ªëng h·∫±ng ng√†y.">Kinh vƒÉn</button>
      <button class="chip" data-text="G·ª£i √Ω 5 ph√°p tho·∫°i MP3 v·ªÅ ch√°nh ni·ªám cho ng∆∞·ªùi m·ªõi.">S√°ch n√≥i / MP3</button>
      <button class="chip" data-text="Gi·∫£i ƒë√°p gi√∫p t√¥i: L√†m sao gi·ªØ ch√°nh ni·ªám gi·ªØa c√¥ng vi·ªác b·∫≠n r·ªôn?">H·ªèi ƒë√°p</button>
      <button class="chip" data-text="H∆∞·ªõng d·∫´n l·ªô tr√¨nh tu t·∫≠p theo c·∫•p ƒë·ªô: nh·∫≠p m√¥n ‚Üí cƒÉn b·∫£n ‚Üí n√¢ng cao.">Tu h·ªçc theo c·∫•p ƒë·ªô</button>
      <button class="chip" data-text="T√¨m ki·∫øm ph√°p tho·∫°i c·ªßa HT. Th√≠ch‚Ä¶ v·ªÅ ch·ªß ƒë·ªÅ t·ª´ bi.">T√¨m ph√°p tho·∫°i</button>
      <button class="chip" data-text="Li·ªát k√™ 10 c√¢u h·ªèi Ph·∫≠t h·ªçc ph·ªï bi·∫øn cho ng∆∞·ªùi m·ªõi.">C√¢u h·ªèi ph·ªï bi·∫øn</button>
    </div>

    <!-- CHAT -->
    <div class="panel">
      <div class="msgs" id="msgs"></div>

      <div class="composer">
        <textarea id="inp" maxlength="800" placeholder="G√µ c√¢u h·ªèi c·ªßa b·∫°n‚Ä¶ (Shift+Enter xu·ªëng d√≤ng)"></textarea>
        <button class="btn" id="send">G·ª≠i</button>
      </div>

      <div class="actions">
        <button class="btn ghost" id="copy">üìã Sao ch√©p c√¢u tr·∫£ l·ªùi</button>
        <button class="btn ghost" id="save">üíæ T·∫£i .txt</button>
        <span class="muted" id="hint">S·∫µn s√†ng.</span>
      </div>
    </div>
  </div>

<script>
/* ====== C·∫•u h√¨nh nh·ªè ƒë·ªÉ ti·∫øt ki·ªám chi ph√≠ ====== */
const SERVER_URL = '/api/chat';
const TEMPERATURE = 0.5;              // ·∫•m v√† gi√†u bi·ªÉu ƒë·∫°t
const MAX_LEN = 800;                   // ch·∫∑n spam input
const MIN_INTERVAL_MS = 5500;          // ƒë·ªô tr·ªÖ gi·ªØa 2 l·∫ßn g·ª≠i ~5.5s

/* ====== Tr·∫°ng th√°i ====== */
const msgsEl = document.getElementById('msgs');
const inp = document.getElementById('inp');
const sendBtn = document.getElementById('send');
const copyBtn = document.getElementById('copy');
const saveBtn = document.getElementById('save');
const hint = document.getElementById('hint');
let history = [];
let lastSentAt = 0;

/* ====== Ti·ªán √≠ch ====== */
function addMsg(role, text, typing=false){
  const el = document.createElement('div');
  el.className = 'msg ' + (role==='user'?'me':'ai') + (typing?' typing':'');
  el.textContent = text;
  msgsEl.appendChild(el);
  msgsEl.scrollTop = msgsEl.scrollHeight;
  return el;
}
function setHint(t){ hint.textContent = t; }
function throttleOK(){
  const now = Date.now();
  if (now - lastSentAt < MIN_INTERVAL_MS) {
    const remain = Math.ceil((MIN_INTERVAL_MS - (now - lastSentAt))/1000);
    setHint(`Ch·ªù ${remain}s n·ªØa ƒë·ªÉ g·ª≠i c√¢u ti·∫øp theo (gi·ªØ ch√°nh ni·ªám, ti·∫øt ki·ªám chi ph√≠)`);
    return false;
  }
  return true;
}

/* ====== G·ª≠i c√¢u h·ªèi ====== */
async function ask(q){
  if (!q.trim()) return;
  if (!throttleOK()) return;
  if (q.length > MAX_LEN) { setHint(`C√¢u h·ªèi qu√° d√†i (${q.length}/${MAX_LEN}). Vui l√≤ng r√∫t g·ªçn.`); return; }

  lastSentAt = Date.now();
  const u = addMsg('user', q);
  const aiTyping = addMsg('assistant', '‚Ä¶ ƒëang suy ni·ªám v√† tr·∫£ l·ªùi ‚Ä¶', true);
  inp.value = ''; setHint('ƒêang h·ªèi‚Ä¶'); sendBtn.disabled = true;

  // Gh√©p h·ªá th·ªëng + few-shot ·∫•m √°p
  const system = {
    role: 'system',
    content:
      'B·∫°n l√† Ph√°p B·∫£o Ph√∫c L·∫°c ‚Äî tr·ª£ l√Ω Ph·∫≠t h·ªçc t·ª´ bi, khi√™m cung, ng·∫Øn g·ªçn m√† ·∫•m √°p; ' +
      'g·ª£i m·ªü th·ª±c h√†nh ch√°nh ni·ªám. Khi th√≠ch h·ª£p, tr√¨nh b√†y g·∫°ch ƒë·∫ßu d√≤ng d·ªÖ ƒë·ªçc.'
  };
  const fewshots = [
    {role:'user',content:'ƒê·∫°o Ph·∫≠t l√† g√¨ v·∫≠y ·∫°? Con th·∫•y nhi·ªÅu ng∆∞·ªùi n√≥i m√† v·∫´n ch∆∞a hi·ªÉu r√µ.'},
    {role:'assistant',content:'D·∫°, c·∫£m ∆°n c√¢u h·ªèi r·∫•t ƒë·∫πp c·ªßa b·∫°n. ƒê·∫°o Ph·∫≠t l√† con ƒë∆∞·ªùng ƒë∆∞a t·ªõi an l·∫°c v√† gi√°c ng·ªô, do ƒê·ª©c Ph·∫≠t ch·ªâ d·∫°y. Ng√†i khuy√™n m√¨nh t·ª± quan s√°t th√¢n t√¢m, nh·∫≠n di·ªán kh·ªï, nguy√™n nh√¢n c·ªßa kh·ªï, v√† th·ª±c h√†nh t·ª´ bi ‚Äì tr√≠ tu·ªá ƒë·ªÉ chuy·ªÉn h√≥a. N·∫øu b·∫°n mu·ªën, m√¨nh c√≥ th·ªÉ ƒëi t·ª´ng b∆∞·ªõc: T·ª© Di·ªáu ƒê·∫ø v√† B√°t Ch√°nh ƒê·∫°o.'},
    {role:'user',content:'L√†m sao gi·ªØ ch√°nh ni·ªám gi·ªØa c√¥ng vi·ªác b·∫≠n r·ªôn?'},
    {role:'assistant',content:'B·∫°n c√≥ th·ªÉ b·∫Øt ƒë·∫ßu r·∫•t nh·∫π nh√†ng: (1) M·ªôt h∆°i th·ªü s√¢u khi ƒë·ªïi vi·ªác; (2) ƒê·∫∑t tr·ªçn v·∫πn s·ª± ch√∫ √Ω v√†o vi·ªác ƒëang l√†m; (3) M·ªói gi·ªù ngh·ªâ 1 ph√∫t l·∫∑ng; (4) K·∫øt th√∫c ng√†y b·∫±ng bi·∫øt ∆°n. Nh·ªè m√† b·ªÅn th√¨ ch√°nh ni·ªám n·ªü hoa.'}
  ];
  const payload = {
    model: "gpt-4o-mini",
    temperature: TEMPERATURE,
    messages: [system, ...fewshots, ...history, {role:'user', content: q}]
  };

  try{
    const r = await fetch(SERVER_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ messages: payload.messages })
    });
    if(!r.ok){ throw new Error(await r.text()); }
    const data = await r.json();
    const reply = data.reply || 'Xin l·ªói, h·ªá th·ªëng t·∫°m b·∫≠n.';
    aiTyping.classList.remove('typing');
    aiTyping.textContent = reply;
    history.push({role:'user',content:q},{role:'assistant',content:reply});
    setHint('Ho√†n t·∫•t. B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c c√¢u h·ªèi kh√°c.');
  }catch(e){
    aiTyping.classList.remove('typing');
    aiTyping.textContent = 'Xin l·ªói, h·ªá th·ªëng ƒëang b·∫≠n ho·∫∑c API ch∆∞a s·∫µn s√†ng.';
    setHint('C√≥ l·ªói k·∫øt n·ªëi. Th·ª≠ l·∫°i sau √≠t ph√∫t.');
  }finally{
    sendBtn.disabled = false;
  }
}

/* ====== S·ª± ki·ªán ====== */
sendBtn.onclick = ()=> ask(inp.value);
inp.addEventListener('keydown', (e)=>{
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); ask(inp.value); }
});
document.getElementById('quickMenu').addEventListener('click', (e)=>{
  if(e.target.matches('.chip')){ inp.value = e.target.dataset.text; inp.focus(); }
});

/* ====== Sao ch√©p / T·∫£i TXT ====== */
copyBtn.onclick = ()=>{
  const lastAI = [...document.querySelectorAll('.ai')].pop();
  if(!lastAI){ setHint('Ch∆∞a c√≥ c√¢u tr·∫£ l·ªùi ƒë·ªÉ sao ch√©p.'); return; }
  navigator.clipboard.writeText(lastAI.textContent);
  setHint('ƒê√£ sao ch√©p c√¢u tr·∫£ l·ªùi.');
};
saveBtn.onclick = ()=>{
  const all = [...document.querySelectorAll('.msg')].map(el=> (el.classList.contains('me')?'B·∫°n: ':'PBPL: ') + el.textContent).join('\n\n');
  const blob = new Blob([all], {type:'text/plain;charset=utf-8'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'pbpl_chat.txt'; a.click(); URL.revokeObjectURL(a.href);
};
</script>
</body>
</html>
